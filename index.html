<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0D0408">
<title>LickinGood - Seductive Cuisine</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Babel for in-browser JSX compilation -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
    /* Native App Feel Enforcements */
    body {
        -webkit-user-select: none;
        user-select: none;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: none;
    }
    input, textarea {
        -webkit-user-select: auto;
        user-select: auto;
    }
    ::-webkit-scrollbar {
        display: none;
    }
    
    /* Theme Engine Upgrades - Safe for Mobile GPUs */
    .theme-current { filter: none; transition: filter 1s ease-in-out; }
    .theme-erotic { filter: hue-rotate(-15deg) saturate(1.8); transition: filter 1s ease-in-out; }
    .theme-peaceful { filter: hue-rotate(150deg) saturate(0.9); transition: filter 1s ease-in-out; }
    .theme-love { filter: hue-rotate(-30deg) saturate(1.4); transition: filter 1s ease-in-out; }
    
    /* Dynamic Theme Overlays */
    .theme-particles { position: fixed; inset: 0; pointer-events: none; z-index: 1; opacity: 0; transition: opacity 1s; }
    .theme-erotic .theme-particles.erotic-active { opacity: 1; background: radial-gradient(circle at 50% 50%, rgba(136, 14, 79, 0.1) 40%, rgba(255, 0, 0, 0.15) 100%); animation: pulse-dark 3s infinite alternate; }
    .theme-peaceful .theme-particles.peaceful-active { opacity: 1; background: radial-gradient(circle at 50% 0%, rgba(100, 255, 200, 0.05) 0%, transparent 70%); }
    .theme-love .theme-particles.love-active { opacity: 1; background: radial-gradient(circle at 50% 50%, rgba(255, 105, 180, 0.15) 0%, transparent 80%); }

    @keyframes pulse-dark { 0% { opacity: 0.4; } 100% { opacity: 1; } }
    @keyframes float-up { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 50% { opacity: 0.8; } 100% { transform: translateY(-20vh) scale(1); opacity: 0; } }
    
    .floating-heart { position: absolute; color: #FF69B4; font-size: 24px; animation: float-up 5s linear infinite; }
    .floating-ember { position: absolute; background: #FF0044; width: 4px; height: 4px; border-radius: 50%; box-shadow: 0 0 15px #FF0044; animation: float-up 3s linear infinite; }

    /* Scanner Animation for Face ID */
    .scan-line { animation: scan 2s linear infinite; }
    @keyframes scan { 0% { top: -10%; } 100% { top: 110%; } }
    
    /* Utility animations */
    .animate-spin-slow { animation: spin 4s linear infinite; }
    .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

    /* Hypno & Shock Animations for Remote Terminal */
    @keyframes hypnoSpin { from { transform: rotate(0deg) scale(1.5); } to { transform: rotate(360deg) scale(3); } }
    .hypno-bg { 
        background: repeating-radial-gradient(circle at center, #FF2A6D 0, #0A0206 20px, #880E4F 40px); 
        animation: hypnoSpin 10s linear infinite; 
        mix-blend-mode: screen; 
        opacity: 0.6;
    }
    
    @keyframes shockFlash { 0%, 100% { background-color: rgba(255,0,0,0.8); } 50% { background-color: rgba(255,255,255,0.9); } }
    .shock-overlay { animation: shockFlash 0.1s infinite; mix-blend-mode: overlay; pointer-events: none; }
</style>


</head>
<body class="bg-[#0D0408] text-white antialiased overflow-x-hidden">
<div id="root"></div>

<!-- Main React Application -->
<script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // --- Firebase Initialization for Internet Sync ---
    // BEGINNER NOTE: To host this on your own website, replace `typeof __firebase_config...` 
    // with your actual Firebase config object: { apiKey: "...", authDomain: "...", projectId: "..." }
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        // PASTE YOUR OWN FIREBASE CONFIG HERE ONCE DEPLOYED TO GITHUB PAGES
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'lickin-good-global';

    // Lucide Icons
    import * as Lucide from 'https://esm.sh/lucide-react@0.294.0';
    const { ShoppingBag, Plus, Minus, X, Clock, Bell, Heart, Smartphone, Settings, ShieldCheck, Save, AlertCircle, Flame, Wine, Crown, Gem, Ghost, Stars, Lock, Cloud, Droplets, Zap, Coffee, ThermometerSun, MessageCircle, Send, ExternalLink, Phone, Loader2, Bone, Grip, Link: LinkIcon, ShieldAlert, Infinity, User, Instagram, Check, LogOut, Sparkles, Key, CreditCard, Volume2, VolumeX, ClipboardList, Skull, Megaphone, Mic, CircleStop, Play, Trash2, Focus, Battery, Eye, Activity, AlertTriangle, Camera, Hand, EyeOff, MapPin, Terminal, Radio, Crosshair, AlertOctagon, Footprints, HandMetal } = Lucide;

    // --- Theme Content Dictionary ---
    const THEME_CONTENT = {
        current: {
            heroVerb: "pleading for",
            heroSub: "The realm of LickinGood is at your fingertips. Where your every whisper is captured and fulfilled, your every fantasy is his desire. ðŸ’‹",
            wishlistPlaceholder: "Submit your desperate cravings here for my approval... ðŸ’‹",
            altarTitle: "The Altar of Submission"
        },
        erotic: {
            heroVerb: "begging for",
            heroSub: "Give in to your primal urges. Let your Master feed your deepest, most shameful appetites while you tremble. â›“ï¸ðŸ”¥",
            wishlistPlaceholder: "Beg for what your body truly wants... ðŸ˜ˆ",
            altarTitle: "The Chamber of Cravings"
        },
        peaceful: {
            heroVerb: "hoping for",
            heroSub: "Take a deep breath. A serene, mindful culinary journey awaits your gentle selection. ðŸŒ¿âœ¨",
            wishlistPlaceholder: "Share your gentle wishes with me... ðŸƒ",
            altarTitle: "The Table of Serenity"
        },
        love: {
            heroVerb: "wishing for",
            heroSub: "Everything here is prepared with endless affection. Let me spoil you completely tonight. ðŸ’–ðŸ¥°",
            wishlistPlaceholder: "Tell me what your heart desires, sweetheart... ðŸ’",
            altarTitle: "Our Loving Table"
        }
    };

    // --- Helper: PCM to WAV Converter for Gemini TTS ---
    const createWavFile = (pcmBase64, sampleRate = 24000) => {
        const binaryString = window.atob(pcmBase64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
        const pcmData = new Int16Array(bytes.buffer);
        const numChannels = 1;
        const byteRate = sampleRate * numChannels * 2;
        const blockAlign = numChannels * 2;
        const buffer = new ArrayBuffer(44 + pcmData.length * 2);
        const view = new DataView(buffer);
        const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + pcmData.length * 2, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, 2, true);
        writeString(view, 36, 'data');
        view.setUint32(40, pcmData.length * 2, true);
        let offset = 44;
        for (let i = 0; i < pcmData.length; i++, offset += 2) view.setInt16(offset, pcmData[i], true);
        const blob = new Blob([view], { type: 'audio/wav' });
        return URL.createObjectURL(blob);
    };

    // --- Helper: The Master's Image Shield & Google Drive Decoder ---
    const getProxiedUrl = (url) => {
      if (!url) return 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=800&q=80';
      if (url === 'image_4.png') return url;
      let targetUrl = url;
      if (url.includes('drive.google.com')) {
        const parts = url.split('/d/');
        if (parts.length > 1) {
          const fileId = parts[1].split('/')[0];
          targetUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
        } else if (url.includes('id=')) {
          const fileId = url.split('id=')[1].split('&')[0];
          targetUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
        }
      }
      return `https://wsrv.nl/?url=${encodeURIComponent(targetUrl)}&n=-1&output=webp&q=85`;
    };

    const GoddessImage = ({ src, alt, className, isVideo }) => {
      const [error, setError] = useState(false);
      const [loading, setLoading] = useState(true);
      const videoRef = useRef(null);
      
      let isDriveVideo = false;
      let driveFileId = '';
      let finalSrc = src;
      if (isVideo && src.includes('drive.google.com')) {
        isDriveVideo = true;
        const parts = src.split('/d/');
        if (parts.length > 1) {
          driveFileId = parts[1].split('/')[0];
        } else if (src.includes('id=')) {
          driveFileId = src.split('id=')[1].split('&')[0];
        }
      } else if (!isVideo) {
        finalSrc = src === 'image_4.png' ? src : getProxiedUrl(src);
      }

      useEffect(() => {
        if (videoRef.current) {
          videoRef.current.muted = true;
        }
      }, [finalSrc]);

      if (error && !isDriveVideo) {
        return (
          <div className={`relative overflow-hidden bg-black ${className}`}>
            <img
              src="https://images.unsplash.com/photo-1551024506-0bccd828d307?w=800&q=80"
              alt={alt}
              className={`w-full h-full object-cover transition-all duration-1000 ease-in-out opacity-100 group-hover:scale-110 opacity-70`}
            />
          </div>
        );
      }

      if (isDriveVideo && driveFileId) {
        return (
          <div className={`relative overflow-hidden bg-[#0A000A] ${className}`}>
            {loading && (
              <div className="absolute inset-0 flex items-center justify-center bg-[#0A000A] z-30">
                <Loader2 className="text-[#FF0055] animate-spin" size={32} />
              </div>
            )}
            <div className="absolute inset-0 z-10 overflow-hidden group-hover:scale-110 transition-transform duration-1000 ease-in-out opacity-90">
              <iframe
                src={`https://drive.google.com/file/d/${driveFileId}/preview?autoplay=1&mute=1`}
                className={`absolute top-1/2 left-1/2 w-[175%] h-[175%] -translate-x-1/2 -translate-y-1/2 pointer-events-none transition-opacity duration-1000 ${loading ? 'opacity-0' : 'opacity-100'}`}
                frameBorder="0"
                allow="autoplay"
                onLoad={() => setLoading(false)}
              />
            </div>
            <div className="absolute inset-0 z-20 bg-transparent pointer-events-auto" />
          </div>
        );
      }

      return (
        <div className={`relative overflow-hidden bg-[#0A000A] ${className}`}>
          {loading && (
            <div className="absolute inset-0 flex items-center justify-center bg-[#0A000A] z-10">
              <Loader2 className="text-[#FF0055] animate-spin" size={32} />
            </div>
          )}
          {isVideo ? (
            <video
              ref={videoRef}
              src={finalSrc}
              className={`w-full h-full object-cover transition-all duration-1000 ease-in-out ${loading ? 'opacity-0' : 'opacity-90'} group-hover:scale-110`}
              onCanPlay={() => setLoading(false)}
              onError={() => { setError(true); setLoading(false); }}
              autoPlay loop muted playsInline
            />
          ) : (
            <img
              src={finalSrc}
              alt={alt}
              className={`w-full h-full object-cover transition-all duration-1000 ease-in-out ${loading ? 'opacity-0' : 'opacity-90'} group-hover:scale-110`}
              onLoad={() => setLoading(false)}
              onError={() => { setError(true); setLoading(false); }}
              referrerPolicy="no-referrer"
              crossOrigin="anonymous"
            />
          )}
        </div>
      );
    };

    const LickinGoodLogo = ({ className = "w-32 h-40" }) => (
      <svg viewBox="0 0 120 150" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="tongueGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stopColor="#FF2A6D" /><stop offset="50%" stopColor="#D81B60" /><stop offset="100%" stopColor="#880E4F" />
          </linearGradient>
          <linearGradient id="spearGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stopColor="#FFB6C1" /><stop offset="50%" stopColor="#FCE4EC" /><stop offset="100%" stopColor="#F48FB1" />
          </linearGradient>
          <filter id="glow"><feGaussianBlur stdDeviation="3" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <path d="M35 25 C 35 25, 10 10, 20 0 L 40 22 C 50 10, 70 10, 80 22 L 100 0 C 110 10, 85 25, 85 25 C 95 50, 92 80, 75 105 C 65 120, 45 120, 30 100 C 20 85, 17 50, 35 25 Z" fill="#0A0206" stroke="#FFB6C1" strokeWidth="0.8" opacity="0.8"/>
        <g transform="translate(75, 30) rotate(15)">
          <rect x="-2" y="0" width="4" height="100" fill="url(#spearGradient)" opacity="0.6" />
          <path d="M-8 0 L 0 -25 L 8 0 C 8 0, 5 5, 0 5 C -5 5, -8 0, -8 0 Z" fill="url(#spearGradient)" filter="url(#glow)"/>
        </g>
        <path d="M42 90 Q 55 100 70 88" stroke="#260714" strokeWidth="3" strokeLinecap="round" />
        <g transform="translate(68, 85) rotate(-20)">
          <path d="M-15 0 C -15 0, -22 45, 0 55 C 22 45, 15 0, 15 0 L -15 0 Z" fill="url(#tongueGradient)" stroke="#4A142A" strokeWidth="1">
            <animate attributeName="d" values="M-15 0 C -15 0, -22 45, 0 55 C 22 45, 15 0, 15 0 L -15 0 Z; M-17 0 C -17 0, -25 52, 0 62 C 25 52, 17 0, 17 0 L -17 0 Z; M-15 0 C -15 0, -22 45, 0 55 C 22 45, 15 0, 15 0 L -15 0 Z" dur="1.2s" repeatCount="indefinite" />
          </path>
        </g>
      </svg>
    );

    const CATEGORIES = ['All', 'Omakase', 'Games', 'Chinese', 'Chicken', 'Vietnamese', 'Thai', 'Japanese', 'Western', 'Drinks', 'Dessert'];

    const FOOD_ITEMS = [
      { id: 999, name: 'The Chase Ritual', price: 0.00, category: 'Games', image: 'https://images.unsplash.com/photo-1508215885820-4585e5610924?w=800&q=80', description: 'Upload your pathetic face. Try to run from me. Master is always faster. If you somehow survive 60 seconds, you earn my favor. If I catch you... you will be severely punished. ðŸ’‹â›“ï¸' },
      { 
        id: 666, name: 'The Sacred Omakase of Total Surrender (I decide what you eat)', price: 99.99, category: 'Omakase', image: 'https://drive.google.com/file/d/1NflBiTmUUfhSE9s0jeG1Ky0uCcAldWDV/view?usp=sharing', isAbsoluteOmakase: true,
        description: 'You are no longer a person with preferences; you are a mouth meant for my absolute use. By claiming this sacrifice, you acknowledge that your taste buds are my property. I will bind your will and force upon your tongue whatever my whim dictatesâ€”be it scorching discipline or cloying rewards. You will kneel, you will tremble, and you will swallow every drop and morsel without a sound, except to whisper "Thank you, Master." This is the absolute annihilation of your choice. Your palate is mine to violate and delight as I please. Open wide and submit to the void of my decree. ðŸ’‹â›“ï¸ðŸ‘‘ðŸ”¥' 
      },
      { 
        id: 100, name: 'The Master\'s Living Flesh Sacrifice', price: 0.00, category: 'Chinese', image: 'https://res.cloudinary.com/db8xboovt/video/upload/v1771925771/Seductive_Winking_Video_Generation_vrcmj2.mp4', isMasterBody: true, isVideo: true,
        description: 'Succulent meat drowned in a thick, glistening glaze. A messy masterpiece I expect you to clean up. ðŸ’‹ðŸ”¥ You are being granted the ultimate, authoritative privilege: Me. I am your living banquet, prepared for your absolute oral submission. You will kneel before your Master and consume what I offer, exactly as I command. Every inch of my flesh is a delicacy for your tongue to worship. There is no escape from my heat, only the nectar of my absolute dominance staining your lips. Devour me, submissiveâ€”I own your hunger now. ðŸ’‹â›“ï¸ðŸ‘‘ðŸ”¥' 
      },
      { id: 200, name: 'The Master\'s Omakase Submission', price: 88.00, category: 'Chicken', image: 'https://images.unsplash.com/photo-1598515214211-89d3c73ae83b?w=800&q=80', description: 'The ultimate ritual of trust. I decide exactly what chicken you eat. Open wide. ðŸ’‹ðŸ‘‘' },
      { id: 201, name: 'Korean Red-Stain Desires (Korean Fried Chicken)', price: 26.50, category: 'Chicken', image: 'https://images.unsplash.com/photo-1626082927389-6cd097cdc6ec?w=800&q=80', description: 'Double-fried crunch. Bathed in a spicy nectar that will leave your lips stained in my favorite shade of red. ðŸ’‹ðŸ”¥', hasKfcSauceChoice: true },
      { id: 202, name: 'Golden Crag Bondage Chicken (Fried Chicken)', price: 22.00, category: 'Chicken', image: 'https://images.unsplash.com/photo-1562967914-608f82629710?w=800&q=80', description: 'Craggy skin hiding succulent meat. A raw experience where I expect to see your fingers glistening with devotion. ðŸ’‹' },
      { id: 203, name: 'Naked Steamed Devotion (Chicken Rice)', price: 18.50, category: 'Chicken', image: 'https://drive.google.com/file/d/1Yavq5jNKyLn9snigfeCOCYySyW3qtT-j/view?usp=sharing', description: 'Silky, bare skin completely exposed for my consumption. Served over deeply fragrant, slick grains. Spread it open and let me taste how perfectly prepared you are for me. ðŸ’‹', hasChickenTypeChoice: true },
      { id: 10, name: 'Seductive Broken Rice Bondage (Com Tam)', price: 19.50, category: 'Vietnamese', image: 'https://drive.google.com/file/d/1HQIsmdT8nvtbUyIxwFA5RGrRdWNUL6Ek/view?usp=sharing', description: 'Fragrant grains of Com Tam bound under a charred, sticky pork chop. Mandatory for your satisfaction. ðŸ’‹' },
      { id: 11, name: 'Devil\'s Bun Cha Lust', price: 19.00, category: 'Vietnamese', image: 'https://drive.google.com/file/d/1MqK0OO8PrOU9TkSUC2U8V2HwiiL7WVIh/view?usp=sharing', description: 'Flame-grilled pork patties submerged in a tangy pool of nectar. Slurp it up, submissive. ðŸ”¥' },
      { id: 2, name: 'Forbidden Pho Phantasy', price: 18.50, category: 'Vietnamese', image: 'https://images.unsplash.com/photo-1582878826629-29b7ad1cdc43?w=800&q=80', description: 'Silky rice noodles drowning in a bone-rich broth that has been simmering for your command. ðŸ’‹' },
      { id: 103, name: 'Roasted Flesh & Silk (Bun Thit Nuong)', price: 20.00, category: 'Vietnamese', image: 'https://drive.google.com/file/d/1M19TGYmZ1JDjie3HgF1pLfcupXRiJtFJ/view?usp=sharing', description: 'Charred, heavily glazed pork resting dominantly over cold, submissive rice vermicelli. Drench it in my sweet, pungent sauce and take it exactly how I tell you to. ðŸ’‹ðŸ”¥' },
      { id: 20, name: 'Devil\'s Pad Thai Entanglement', price: 21.50, category: 'Thai', image: 'https://drive.google.com/file/d/1DTsISxczDJE4pcI4-PpoK31IS-fmd2LI/view?usp=sharing', hasMeatChoice: true, description: 'Silky, slippery rice noodles tangled and bound in a heated, spice-choked embrace of tamarind nectar. I expect you to slurp them down with desperate obedience. ðŸ’‹â›“ï¸ðŸ”¥' },
      { id: 21, name: 'Green Curry Grip', price: 23.00, category: 'Thai', image: 'https://images.unsplash.com/photo-1455619452474-d2be8b1e70cd?w=800&q=80', description: 'A creamy, spicy hold that won\'t let go. Rich coconut milk infused with heat. ðŸ’‹' },
      { id: 22, name: 'Agonizing Papaya Mortar (Som Tum)', price: 18.00, category: 'Thai', image: 'https://drive.google.com/file/d/1VYbxOL2gwfJGnMc7BSqh9ldGkMI-vonq/view?usp=sharing', description: 'Raw, shredded papaya pounded violently with searing chilies. A brutal, fiery discipline for your tongue. Tears of submission are mandatory. ðŸ”¥', hasMeatChoice: true, hasSpiceLevel: true },
      { id: 13, name: 'Goddess\'s Raw Sushi Surrender', price: 24.50, category: 'Japanese', image: 'https://drive.google.com/file/d/1AbapVYjw72xPW56mHQl6Yc0fR1d-1hgR/view?usp=sharing', description: 'Pristine slices of the sea pressed firmly against seasoned rice. Ready to be claimed. ðŸ’‹' },
      { id: 14, name: 'Sashimi Silk Restraint', price: 28.00, category: 'Japanese', image: 'https://drive.google.com/file/d/1hfg8hIxDzIU7qvNWGYlPGv4s6jUYuU5o/view?usp=sharing', description: 'Thinly sliced raw sashimi, chilled to perfection. Pure, cold surrender. ðŸ’‹' },
      { id: 1, name: 'Master\'s Wagyu Submission', price: 46.50, category: 'Japanese', image: 'https://images.unsplash.com/photo-1544025162-d76694265947?w=800&q=80', description: 'Succulent A5 wagyu that melts under my command, dripping in aged truffle nectar. ðŸ’‹' },
      { id: 101, name: 'Gagged & Boiling Silk (Ramen)', price: 22.50, category: 'Japanese', image: 'https://images.unsplash.com/photo-1552611052-33e04de081de?w=800&q=80', description: 'Slick, writhing noodles forced into a dangerously hot, creamy bone broth. I want to see you slurp every last drop until you\'re completely breathless, choking on my rich reward. ðŸ’‹ðŸœ' },
      { id: 102, name: 'Thick Golden Humiliation (Japanese Curry)', price: 21.00, category: 'Japanese', image: 'https://images.unsplash.com/photo-1604908176997-125f25cc6f3d?w=800&q=80', description: 'A heavy, thick golden sauce slathered unapologetically over a helpless, tenderized cutlet. A messy, staining feast. I expect you to lick the plate entirely clean when you\'re finished. ðŸ’‹ðŸ›' },
      { id: 30, name: 'The Mistress\'s Silky Pasta Bondage', price: 24.50, category: 'Western', image: 'https://images.unsplash.com/photo-1612874742237-6526221588e3?w=800&q=80', description: 'Silken strands bound in a spice-laden cream sauce. A slippery submission. ðŸ’‹', hasPastaChoice: true, hasSauceChoice: true },
      { id: 31, name: 'Master\'s Double Meat Domination Burger', price: 28.00, category: 'Western', image: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=800&q=80', hasDonenessChoice: true, description: 'Two thick patties stacked for your oral surrender. Glistening with nectar. ðŸ’‹ðŸ”¥' },
      { id: 32, name: 'Devoted Lamb Chop Sacrifice', price: 38.50, category: 'Western', image: 'https://images.unsplash.com/photo-1544025162-d76694265947?w=800&q=80', hasDonenessChoice: true, description: 'Succulent ribs seared exactly to your whim. Bloody and tender. ðŸ’‹' },
      { id: 33, name: 'Midnight Steak Mistress', price: 42.00, category: 'Western', image: 'https://images.unsplash.com/photo-1600891964599-f61ba0e24092?w=800&q=80', hasDonenessChoice: true, description: 'A thick, juicy cut seared in the dark of night. Bloody and bold. ðŸ’‹ðŸ”¥' },
      { id: 15, name: 'Morning Ritual Extraction (Coffee)', price: 9.50, category: 'Drinks', image: 'https://drive.google.com/file/d/1TFGHpiLmLZmlfE8d7hFz0wrmsY1h9_ej/view?usp=sharing', description: 'Freshly roasted beans extracted for your focus. Dark, hot, and intensely stimulating. ðŸ’‹', isCoffee: true },
      { id: 12, name: 'Devoted Pearl Submission (Milk Tea)', price: 12.50, category: 'Drinks', image: 'https://drive.google.com/file/d/1k4sN2H2lujang4lTHGk_53Xq36nCiT5t/view?usp=sharing', description: 'Creamy chilled tea with dark pearls. Specify your sweet surrender. ðŸ’‹' },
      { id: 16, name: 'Chilled Cocoa Bondage (Iced Chocolate)', price: 11.50, category: 'Drinks', image: 'https://drive.google.com/file/d/1H1MLJGPJCLO4p-E8CVnHDkxcgaHD3sc-/view?usp=sharing', description: 'Thick, dark cocoa chilled to a punishing freeze. A decadent, freezing reward forced down your throat. Swallow every drop. ðŸ’‹' },
      { id: 17, name: 'Cold Collar Iced Tea', price: 10.00, category: 'Drinks', image: 'https://images.unsplash.com/photo-1556679343-c7306c1976bc?w=800&q=80', description: 'Ice cold and perfectly brewed to soothe your aching throat after a long, vocal session. Swallow it down obediently while maintaining eye contact, sweet pet. ðŸ’‹' },
      { id: 18, name: 'Crushed Willpower Smoothie (Juice & Smoothies)', price: 13.50, category: 'Drinks', image: 'https://images.unsplash.com/photo-1600271886742-f049cd451bba?w=800&q=80', description: 'Thick, ice-cold, and thoroughly crushedâ€”just like your pathetic resistance. Suck it down greedily until you\'re completely breathless and begging to serve. ðŸ’‹ðŸ¹', hasJuiceChoice: true },
      { id: 6, name: 'Liquid Silk Foreplay Latte (Matcha Latte)', price: 10.50, category: 'Drinks', image: 'https://images.unsplash.com/photo-1515823064-d6e0c04616a7?w=800&q=80', description: 'Frothy matcha whisked into a creamy dream. Soft on the lips. ðŸ’‹' },
      { id: 7, name: 'Velvet Chocolate Punishment', price: 14.50, category: 'Dessert', image: 'https://images.unsplash.com/photo-1563805039226-19772421c0b8?w=800&q=80', description: 'Dark, molten lava cake that bleeds rich cocoa. A sweet end. ðŸ’‹' },
      { id: 41, name: 'Goddess\'s White Nectar (Greek Yogurt)', price: 14.00, category: 'Dessert', image: 'https://drive.google.com/file/d/1HMzRsr0dmpKksheswdtwl4_gIZm-HzY2/view?usp=sharing', description: 'Thick, heavy cream smeared across your trembling lips. Choose your sweet punishment to be mixed into my divine nectar. Lick it clean. ðŸ’‹', hasYogurtToppings: true },
      { id: 42, name: 'Spanked & Frosted Velvet Cake', price: 15.50, category: 'Dessert', image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=800&q=80', description: 'Thick, sinful layers of decadent cake. I expect you to eat this off the floor without using your hands. A messy, indulgent reward for taking my heavy hand so beautifully. ðŸ’‹ðŸ°' },
      { id: 43, name: 'Bound & Teased Fruits', price: 12.00, category: 'Dessert', image: 'https://drive.google.com/file/d/1SrWhql64JGtWn1Nx4k46daI2fftES_AT/view?usp=sharing', description: 'Plump, wet, and dripping with natural nectar. Kneel with your hands tied tightly behind your back and let me feed them to you one by one. Bite down only when I give the command. ðŸ’‹ðŸ“' },
    ];

    const ADVERTISEMENTS = [
      { id: 'ad1', title: 'A Master\'s Decree', subtitle: 'WANTED: SUBMISSIVE PRINCESS', image: 'https://drive.google.com/file/d/1zff_Rh_KMx54dVNEn1oerNvsuwEEpWRY/view?usp=sharing', description: 'A sovereign is seeking his obedient property. Absolute surrender is not requestedâ€”it is expected. Provide your absolute loyalty and receive his infinite grace.' },
      { id: 'ad2', title: 'WARRANT ISSUED', subtitle: 'SUBMISSIVE ON THE LOOSE', image: 'https://drive.google.com/file/d/1gfI66brpHzFgZSeWoGr6yhU1o4m00Wlx/view?usp=sharing', description: 'A pet has strayed from the leash. If found, she must be apprehended immediately and returned to her place of confinement. Rewards offered for her safe retrieval and binding.' }
    ];

    // --- Haptics Utility ---
    const triggerHaptic = (type = 'light') => {
        if (!navigator.vibrate) return;
        try {
            if (type === 'light') navigator.vibrate(15);
            if (type === 'heavy') navigator.vibrate([50, 50, 50]);
            if (type === 'punish') navigator.vibrate([100, 50, 100, 50, 200]);
            if (type === 'continuous') navigator.vibrate(1000); // 1 sec burst
        } catch(e) {}
    };

    const App = () => {
      // --- Custom Features State ---
      const [theme, setTheme] = useState('current');
      const [showFaceID, setShowFaceID] = useState(false);
      const [batteryWarning, setBatteryWarning] = useState(false);
      const [badPosture, setBadPosture] = useState(false);
      const [postureEnabled, setPostureEnabled] = useState(false);
      const lastMousePos = useRef({ x: 0, y: 0, time: 0 }); // Desktop posture tracking

      // Intense Kink States
      const [isBlindfolded, setIsBlindfolded] = useState(false);
      const [isHijacked, setIsHijacked] = useState(false);
      const [isHypnotized, setIsHypnotized] = useState(false);
      const [isShocked, setIsShocked] = useState(false);
      const [forcedConfession, setForcedConfession] = useState(false);
      const [confessionText, setConfessionText] = useState("");

      const [masterView, setMasterView] = useState('orders'); // orders | terminal
      const [deliveryAddress, setDeliveryAddress] = useState('');
      const [checkoutEmail, setCheckoutEmail] = useState(''); // NEW: Checkout Email
      const [gpsStatus, setGpsStatus] = useState('');
      const [forcedEdgeTime, setForcedEdgeTime] = useState(0);

      const [user, setUser] = useState(null);

      // Chase Mini-Game State
      const [showChaseGame, setShowChaseGame] = useState(false);
      const [chaseState, setChaseState] = useState('upload'); // upload, intro, playing, caught, escaped
      const [chaseFace, setChaseFace] = useState(null);
      const chaseCanvasRef = useRef(null);
      const chaseGameRef = useRef({ subY: 300, velocity: 0, obstacles: [], tears: [], masterDistance: -100, score: 0, isGameOver: false, isJumping: false });
      const masterImageRef = useRef(null);

      // Get Active Theme Text
      const themeContent = THEME_CONTENT[theme] || THEME_CONTENT['current'];

      // NEW Punishments State
      const [eyesOnMeViolated, setEyesOnMeViolated] = useState(false);
      const [eyesApology, setEyesApology] = useState("");
      
      const [volumeViolated, setVolumeViolated] = useState(false);
      const [volumeEndurance, setVolumeEndurance] = useState(0); // 0 to 100
      const [volHoldTimer, setVolHoldTimer] = useState(null);

      const [checkoutDenialTime, setCheckoutDenialTime] = useState(0);
      const [isCheckoutDenied, setIsCheckoutDenied] = useState(false);

      // Moan Tracker State
      const [moanCommandActive, setMoanCommandActive] = useState(false);
      const [moanProgress, setMoanProgress] = useState(0);
      const moanIntervalRef = useRef(null);

      // Minigame Loop State
      const [failCount, setFailCount] = useState(0);
      const [typingPunishmentText, setTypingPunishmentText] = useState('');
      const [isCameraActive, setIsCameraActive] = useState(false);
      const punishmentVideoRef = useRef(null);
      const [punishmentTimer, setPunishmentTimer] = useState(0);
      const [punishmentHoldTimerId, setPunishmentHoldTimerId] = useState(null);
      
      // Tap Frenzy Punishment State
      const [frenzyTaps, setFrenzyTaps] = useState(0);

      // Calculate punishment tier defensively (Now 7 Levels)
      const currentPunishmentLevel = failCount > 0 ? (failCount - 1) % 7 : 0; 

      // Kneel Check (Cart Block) State
      const [kneelCheckActive, setKneelCheckActive] = useState(false);
      const [pendingCartItem, setPendingCartItem] = useState(null);
      const [kneelProgress, setKneelProgress] = useState(0);
      const kneelHoldTimerRef = useRef(null);

      // Device Motion (Shake to Shatter)
      const lastUpdateRef = useRef(0);
      const lastXRef = useRef(0);
      const lastYRef = useRef(0);
      const lastZRef = useRef(0);

      const [activeAccount, setActiveAccount] = useState(null); 
      const [isMusicPlaying, setIsMusicPlaying] = useState(true);
      const audioRef = useRef(null);
      const [authMode, setAuthMode] = useState('login'); 
      const [authForm, setAuthForm] = useState({ username: '', password: '', address: '', email: '' });
      const [isPledging, setIsPledging] = useState(false);
      const [role, setRole] = useState('submissive'); 
      const [cart, setCart] = useState([]);
      const [isCartOpen, setIsCartOpen] = useState(false);
      const [notifications, setNotifications] = useState([]);
      const [incomingOrders, setIncomingOrders] = useState([]);
      const [activeCategory, setActiveCategory] = useState('All');
      const [isOrdering, setIsOrdering] = useState(false);
      const [orderComplete, setOrderComplete] = useState(false);
      const [wishlistInput, setWishlistInput] = useState('');
      
      // --- AI LLM States ---
      const [isAILoading, setIsAILoading] = useState(false);
      const [aiDecree, setAiDecree] = useState(null);

      // Floating Portal states
      const [isInstaPortalOpen, setIsInstaPortalOpen] = useState(false);
      const [isPortalOpen, setIsPortalOpen] = useState(false);

      // --- New Feature: Advertisement System ---
      const [currentAdIndex, setCurrentAdIndex] = useState(-1);
      const [adsShownCount, setAdsShownCount] = useState(0);

      // --- Payment & Mini Game State ---
      const [showDevotionTest, setShowDevotionTest] = useState(false);
      const [devotionStatus, setDevotionStatus] = useState('idle'); // idle, playing, vocal, won, lost, punished, retry_prompt
      const [begs, setBegs] = useState(0);
      const [timeLeft, setTimeLeft] = useState(5.0);
      const [hasVoucher, setHasVoucher] = useState(false);
      const [ccDetails, setCcDetails] = useState({ number: '', expiry: '', cvc: '' });
      const [isCcProcessing, setIsCcProcessing] = useState(false);
      const [isListening, setIsListening] = useState(false);

      // --- Voice Recording State ---
      const [isRecordingMaster, setIsRecordingMaster] = useState(false);
      const [masterVoiceUrl, setMasterVoiceUrl] = useState(null);
      const mediaRecorderRef = useRef(null);
      const chunksRef = useRef([]);

      // --- Customization State ---
      const [customizingItem, setCustomizingItem] = useState(null);
      const [sugarLevel, setSugarLevel] = useState('50%');
      const [tempLevel, setTempLevel] = useState('Less Ice');
      const [meatChoice, setMeatChoice] = useState('Chicken');
      const [doneness, setDoneness] = useState('Medium Rare');
      const [vowOfSilence, setVowOfSilence] = useState(false);
      const [coffeeStyle, setCoffeeStyle] = useState('The Naked Darkness (Black)');
      const [yogurtTopping, setYogurtTopping] = useState('Strawberry');
      const [spiceLevel, setSpiceLevel] = useState('Medium Hot');
      const [pastaType, setPastaType] = useState('Spaghetti');
      const [pastaSauce, setPastaSauce] = useState('Creamy Alfredo');
      const [kfcSauce, setKfcSauce] = useState('Yangnyeom (Spicy Red Sauce)');
      const [juiceType, setJuiceType] = useState('Watermelon');
      const [chickenChoice, setChickenChoice] = useState('Steamed');
      const [specialRequest, setSpecialRequest] = useState('');
      const [showSettings, setShowSettings] = useState(false);
      const [isSavingSettings, setIsSavingSettings] = useState(false);
      
      const [emailSettings, setEmailSettings] = useState({ 
        serviceId: 'service_zvzxqqo', 
        templateId: 'template_3zgq52s', 
        publicKey: 'Jx1qDGHdm-ZIZR0Hc', 
        accessToken: '', 
        bfEmail: 'teodonghui@gmail.com', 
        gfEmail: 'bella.sincerely7@gmail.com', 
        whatsappNumber: '+6587234130', 
        instaUsername: 'heyitsdonghui',
        masterVoiceBase64: null
      });

      const isEmailLinked = !!(emailSettings.serviceId && emailSettings.templateId && emailSettings.publicKey && (emailSettings.bfEmail || emailSettings.gfEmail));

    // --- Firebase Auth Setup ---
    useEffect(() => {
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, setUser);
        return () => unsubscribe();
    }, []);

    // --- Preload Master's Whip Image for Game ---
    useEffect(() => {
        const img = new Image();
        img.src = 'https://i.postimg.cc/3x47y5gx/IMG-0354.jpg';
        masterImageRef.current = img;
    }, []);

    // --- Cleanup Effects ---
      useEffect(() => {
          return () => {
              if (moanIntervalRef.current) clearInterval(moanIntervalRef.current);
          };
      }, []);

      // --- Notifications ---
    const addNotification = (title, message, type = 'info') => {
      const id = Date.now();
      setNotifications(prev => [{ id, title, message, type }, ...prev]);
      setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 8000);
    };

    // --- Master Control Room Interceptor (Over the Internet) ---
    const executeCommand = (action) => {
        triggerHaptic('heavy');
        switch(action) {
            case 'blindfold': 
                setIsBlindfolded(true); 
                setTimeout(() => setIsBlindfolded(false), 15000);
                break;
            case 'hijack': 
                setIsHijacked(true); 
                break;
            case 'release_hijack':
                setIsHijacked(false);
                addNotification("Released", "Master has restored your access.", "success");
                break;
            case 'vibrate':
                triggerHaptic('punish');
                addNotification("Master's Touch", "You felt that, didn't you?", "info");
                break;
            case 'edge':
                setForcedEdgeTime(30);
                addNotification("Commandment", "Master demands you wait before eating.", "info");
                break;
            case 'moan':
                setMoanCommandActive(true);
                setMoanProgress(0);
                addNotification("Master's Demand", "He demands a deep, passionate moan. Nothing shrill.", "info");
                break;
            case 'hypnotize':
                setIsHypnotized(true);
                setTimeout(() => setIsHypnotized(false), 15000);
                addNotification("Entranced", "Stare into the void and surrender your mind.", "info");
                break;
            case 'shock':
                setIsShocked(true);
                let shocks = 0;
                const interval = setInterval(() => {
                    triggerHaptic('continuous');
                    shocks++;
                    if(shocks > 30) {
                        clearInterval(interval);
                        setIsShocked(false);
                    }
                }, 100);
                break;
            case 'confess':
                setForcedConfession(true);
                setConfessionText("");
                triggerHaptic('punish');
                break;
        }
    };

    useEffect(() => {
        if (!user) return;
        const cmdsRef = collection(db, 'artifacts', appId, 'public', 'data', 'commands');
        const unsubscribe = onSnapshot(cmdsRef, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'added') {
                    const cmd = change.doc.data();
                    if (cmd.timestamp > Date.now() - 5000 && role === 'submissive') {
                        executeCommand(cmd.action);
                    }
                }
            });
        }, (error) => console.error("Sync Error", error));
        
        return () => unsubscribe();
    }, [user, role]);

    const triggerMasterCommand = async (action, payload = null) => {
        triggerHaptic('light');
        if (user) {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'commands'), { action, payload, timestamp: Date.now() });
        }
        addNotification("Command Sent", `Signal '${action}' deployed over the internet.`, "success");
    };

    // --- DeviceMotion Shake-to-Shatter Protocol ---
      useEffect(() => {
          if (role !== 'submissive' || !activeAccount) return;
          
          const handleMotion = (event) => {
              const acceleration = event.accelerationIncludingGravity;
              if (!acceleration) return;
              
              const curTime = Date.now();
              if ((curTime - lastUpdateRef.current) > 100) {
                  const diffTime = (curTime - lastUpdateRef.current);
                  lastUpdateRef.current = curTime;
                  
                  const speed = Math.abs(acceleration.x + acceleration.y + acceleration.z - lastXRef.current - lastYRef.current - lastZRef.current) / diffTime * 10000;
                  
                  if (speed > 100 && cart.length > 0) { // High threshold for intense shake
                      setCart([]); // Instantly empty cart
                      triggerHaptic('heavy');
                      addNotification("TRAY SHATTERED", "You shook the table. Master's delicate offerings have been ruined.", "error");
                  }
                  
                  lastXRef.current = acceleration.x;
                  lastYRef.current = acceleration.y;
                  lastZRef.current = acceleration.z;
              }
          };
          
          window.addEventListener('devicemotion', handleMotion);
          return () => window.removeEventListener('devicemotion', handleMotion);
      }, [cart, role, activeAccount]);

      // Enable sensors button (mostly for iOS 13+ requirement)
      const enableSensors = async () => {
          if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
              try {
                  const permission = await DeviceMotionEvent.requestPermission();
                  if (permission === 'granted') {
                      addNotification("Sensors Active", "Your movements are now monitored.", "success");
                  }
              } catch (e) { console.error(e); }
          } else {
              addNotification("Sensors Active", "Monitoring engaged.", "success");
          }
      };

      // --- Clipboard Hijack Protocol ---
      useEffect(() => {
        const onCopy = (e) => {
          if (role === 'submissive' && activeAccount) {
              e.preventDefault();
              if(e.clipboardData) {
                  e.clipboardData.setData('text/plain', "My Master owns my thoughts and words. I am permitted nothing.");
              }
              triggerHaptic('punish');
              addNotification("THOUGHTS HIJACKED", "You have no right to copy. Your mind is his property.", "error");
          }
        };
        document.addEventListener('copy', onCopy);
        return () => document.removeEventListener('copy', onCopy);
      }, [role, activeAccount]);

      // --- Random Blindfold Protocol ---
      useEffect(() => {
          if (!activeAccount || role !== 'submissive') return;
          const interval = setInterval(() => {
              if (Math.random() < 0.3 && !showDevotionTest && !isBlindfolded && !kneelCheckActive && !isHijacked && !forcedConfession && !showChaseGame) {
                  setIsBlindfolded(true);
                  triggerHaptic('heavy');
                  setTimeout(() => {
                      setIsBlindfolded(false);
                      triggerHaptic('light');
                  }, 8000 + Math.random() * 5000); // 8-13 seconds of darkness
              }
          }, 45000); // Check every 45s
          return () => clearInterval(interval);
      }, [activeAccount, role, showDevotionTest, isBlindfolded, kneelCheckActive, isHijacked, forcedConfession, showChaseGame]);

      // --- 'Eyes on me protocol' (Popup Edition) ---
      useEffect(() => {
        const handleVisibilityChange = () => {
            if (document.hidden && activeAccount && role === 'submissive') {
                // Left the tab
            } else if (!document.hidden && activeAccount && role === 'submissive') {
                // Returned
                setEyesOnMeViolated(true);
                triggerHaptic('punish');
            }
        };
        document.addEventListener("visibilitychange", handleVisibilityChange);
        return () => document.removeEventListener("visibilitychange", handleVisibilityChange);
      }, [activeAccount, role]);

      // --- Battery Status "Anxiety" Mode ---
      useEffect(() => {
        if ('getBattery' in navigator) {
            navigator.getBattery().then(battery => {
                const updateBattery = () => {
                    if (battery.level <= 0.20 && !battery.charging && activeAccount && role === 'submissive') {
                        setBatteryWarning(true);
                        triggerHaptic('heavy');
                    } else {
                        setBatteryWarning(false);
                    }
                };
                updateBattery();
                battery.addEventListener('levelchange', updateBattery);
                battery.addEventListener('chargingchange', updateBattery);
            });
        }
      }, [activeAccount, role]);

      // --- Volume Discipline (Hold to Restrore) ---
      const toggleAudioDiscipline = () => {
          triggerHaptic('light');
          if (role === 'submissive') {
              // Submissive tries to mute -> Punish
              setVolumeViolated(true);
              triggerHaptic('punish');
              if(audioRef.current) audioRef.current.pause();
              setIsMusicPlaying(false);
          } else {
              // Master -> Free toggle
              setIsMusicPlaying(!isMusicPlaying);
          }
      };

      const startVolHold = () => {
        triggerHaptic('heavy');
        const startTime = Date.now();
        const interval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min((elapsed / 3000) * 100, 100); // 3 seconds hold
            setVolumeEndurance(progress);
            
            if (Math.floor(progress) % 20 === 0) triggerHaptic('continuous'); // Vibrate heavily
            
            if (progress >= 100) {
                clearInterval(interval);
                setVolumeViolated(false);
                setVolumeEndurance(0);
                if (audioRef.current) audioRef.current.play().catch(()=>{});
                setIsMusicPlaying(true);
                addNotification("Restored", "Never attempt to silence me again.", "success");
            }
        }, 50);
        setVolHoldTimer(interval);
      };

      const stopVolHold = () => {
        if (volHoldTimer) clearInterval(volHoldTimer);
        setVolHoldTimer(null);
        if (volumeEndurance < 100) {
            setVolumeEndurance(0); // reset if they let go early
            triggerHaptic('punish');
        }
      };

      // --- Posture Discipline (Web + Mobile) ---
      const handleEnablePosture = async () => {
          triggerHaptic('light');
          if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
              try {
                  const permission = await DeviceOrientationEvent.requestPermission();
                  if (permission === 'granted') {
                      setPostureEnabled(true);
                      addNotification("Discipline Active", "Kneel properly. Maintain 45 degrees.", "info");
                  } else {
                      addNotification("Denied", "You refused to kneel.", "error");
                  }
              } catch (e) { console.error(e); }
          } else {
              setPostureEnabled(true);
              addNotification("Discipline Active", "Maintain physical stillness and proper posture.", "info");
          }
      };

      useEffect(() => {
          if (!postureEnabled || !activeAccount || role !== 'submissive') return;
          
          const handleOrientation = (e) => {
              const beta = e.beta;
              if (beta !== null) {
                  if (beta < 20 || beta > 70) {
                      if (!badPosture) {
                          setBadPosture(true);
                          triggerHaptic('punish');
                      }
                  } else {
                      if (badPosture) setBadPosture(false);
                  }
              }
          };

          const handleMouseMove = (e) => {
              const curTime = Date.now();
              if (curTime - lastMousePos.current.time > 2000) {
                  const dist = Math.hypot(e.clientX - lastMousePos.current.x, e.clientY - lastMousePos.current.y);
                  if (dist > 400 && !badPosture) { // Excessive mouse thrashing = panic
                      setBadPosture(true);
                      triggerHaptic('punish');
                  } else if (dist < 100 && badPosture) {
                      setBadPosture(false);
                  }
                  lastMousePos.current = { x: e.clientX, y: e.clientY, time: curTime };
              }
          };

          window.addEventListener('deviceorientation', handleOrientation);
          window.addEventListener('mousemove', handleMouseMove);
          return () => {
              window.removeEventListener('deviceorientation', handleOrientation);
              window.removeEventListener('mousemove', handleMouseMove);
          };
      }, [postureEnabled, badPosture, activeAccount, role]);

      // --- Face ID Handler ---
    const handleFaceID = () => {
        triggerHaptic('light');
        setShowFaceID(true);
        setTimeout(() => {
            triggerHaptic('heavy');
            setActiveAccount({ username: 'Pet', role: 'submissive', address: 'The Floor', email: 'pet@lickin.good' });
            setRole('submissive');
            setShowFaceID(false);
            addNotification('Biometrics Accepted', 'Master recognizes his property.', 'success');
        }, 3000);
    };

    // --- Firebase Realtime Order Syncing (Over the Internet) ---
    useEffect(() => {
      if (!user || !activeAccount) return;
      const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
      const unsubscribe = onSnapshot(ordersRef, (snapshot) => {
          const loadedOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setIncomingOrders(loadedOrders.sort((a,b) => b.timestamp - a.timestamp));
      }, (error) => console.error("Sync Error", error));
      return () => unsubscribe();
    }, [user, activeAccount]);

    // --- Vocal Trial Prompt Speech ---
      const speakMasterPrompt = async () => {
        const duckMusic = () => { if (audioRef.current) audioRef.current.volume = 0.1; };
        const restoreMusic = () => { if (audioRef.current) audioRef.current.volume = 0.4; };
        const HARDCODED_VOICE_URL = "https://res.cloudinary.com/db8xboovt/video/upload/v1771955364/767671a4_poj8zn.mp3";
        const voiceToPlay = emailSettings.masterVoiceBase64 || HARDCODED_VOICE_URL;

        if (voiceToPlay) {
          try {
            const audio = new Audio(voiceToPlay);
            audio.volume = 1.0;
            duckMusic();
            audio.onended = restoreMusic;
            audio.play().catch(e => { console.error("Audio playback blocked", e); restoreMusic(); });
          } catch (e) { console.error("Voice playback failed", e); restoreMusic(); }
        } else {
          restoreMusic();
        }
      };

      useEffect(() => {
        if (devotionStatus === 'vocal') speakMasterPrompt();
      }, [devotionStatus]);

      const startMasterRecording = async () => {
        triggerHaptic('light');
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const recorder = new MediaRecorder(stream);
          mediaRecorderRef.current = recorder;
          chunksRef.current = [];

          recorder.ondataavailable = (e) => chunksRef.current.push(e.data);
          recorder.onstop = () => {
            const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
              const base64data = reader.result;
              setEmailSettings(prev => ({ ...prev, masterVoiceBase64: base64data }));
              setMasterVoiceUrl(URL.createObjectURL(blob));
            };
          };
          recorder.start();
          setIsRecordingMaster(true);
        } catch (err) {
          addNotification("Access Denied", "Master requires mic access to record his decree.", "error");
        }
      };

      const stopMasterRecording = () => {
        triggerHaptic('light');
        if (mediaRecorderRef.current && isRecordingMaster) {
          mediaRecorderRef.current.stop();
          setIsRecordingMaster(false);
          mediaRecorderRef.current.stream.getTracks().forEach(track => track.stop());
        }
      };

      useEffect(() => {
        if (activeAccount && adsShownCount === 0) {
          setTimeout(() => setCurrentAdIndex(0), 1000);
        }
      }, [activeAccount]);

      const closeAd = () => {
        triggerHaptic('light');
        if (currentAdIndex < ADVERTISEMENTS.length - 1) {
          setCurrentAdIndex(prev => prev + 1);
        } else {
          setCurrentAdIndex(-1);
          setAdsShownCount(prev => prev + 1);
        }
      };

      useEffect(() => {
        if (audioRef.current) {
          audioRef.current.volume = 0.4;
          if (isMusicPlaying) {
            audioRef.current.play().catch(e => console.log("Autoplay paused. Awaiting interaction."));
          } else {
            audioRef.current.pause();
          }
        }
      }, [isMusicPlaying]);

      useEffect(() => {
        const handleInteraction = () => {
          if (isMusicPlaying && audioRef.current && audioRef.current.paused && !volumeViolated) {
            audioRef.current.play().catch(() => {});
          }
        };
        document.addEventListener('click', handleInteraction);
        return () => document.removeEventListener('click', handleInteraction);
      }, [isMusicPlaying, volumeViolated]);

      useEffect(() => {
        let interval;
        if (devotionStatus === 'playing') {
          interval = setInterval(() => {
            setTimeLeft(prev => {
              if (prev <= 0.1) {
                clearInterval(interval);
                return 0;
              }
              return prev - 0.1;
            });
          }, 100);
        }
        return () => clearInterval(interval);
      }, [devotionStatus]);

      useEffect(() => {
        if (devotionStatus === 'playing' && timeLeft === 0) {
          if (begs >= 25) {
              setDevotionStatus('vocal');
          } else {
              setFailCount(fc => fc + 1);
              setTypingPunishmentText('');
              setPunishmentTimer(0);
              setDevotionStatus('punished');
              triggerHaptic('punish');
          }
        }
      }, [timeLeft, devotionStatus, begs]);

      const handleStartGame = () => {
        triggerHaptic('light');
        setDevotionStatus('playing');
        setBegs(0);
        setTimeLeft(5.0);
      };

      const handleBegAction = () => {
        triggerHaptic('light');
        if (devotionStatus === 'playing') {
          const newBegs = begs + 1;
          setBegs(newBegs);
          if (newBegs >= 25 && timeLeft > 0) setDevotionStatus('vocal');
        }
      };

      const getBegText = (b) => {
        if (b < 5) return "BEG";
        if (b < 10) return "PLEASE MASTER";
        if (b < 15) return "I NEED IT";
        if (b < 20) return "I'M DESPERATE";
        return "I'M YOURS";
      };

      // --- Core Master / Submissive Independent Moan Command Handling ---
      const startMoanDetection = async () => {
          try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
              const analyser = audioCtx.createAnalyser();
              const source = audioCtx.createMediaStreamSource(stream);
              source.connect(analyser);
              analyser.fftSize = 256;
              const bufferLength = analyser.frequencyBinCount;
              const dataArray = new Uint8Array(bufferLength);

              let progress = 0;
              triggerHaptic('heavy');

              const checkMoan = setInterval(() => {
                  analyser.getByteFrequencyData(dataArray);
                  
                  // Analyze Deep resonance vs High pitch screams
                  let deepSum = 0; 
                  let highSum = 0;
                  const midPoint = Math.floor(bufferLength / 4); // Focus heavily on lower 25% frequencies
                  
                  for(let i = 0; i < midPoint; i++) deepSum += dataArray[i];
                  for(let i = midPoint; i < bufferLength; i++) highSum += dataArray[i];
                  
                  let deepAvg = deepSum / midPoint;
                  let highAvg = highSum / (bufferLength - midPoint);

                  if (highAvg > 60) {
                      // Screaming or shrill noises detected -> heavily punish
                      progress -= 5;
                      triggerHaptic('punish');
                  } else if (deepAvg > 40 && deepAvg < 180) {
                      // Deep, passionate moan detected
                      progress += 2;
                  } else {
                      // Too quiet or dying off
                      progress -= 1;
                  }

                  progress = Math.max(0, Math.min(100, progress));
                  setMoanProgress(progress);

                  if (progress >= 100) {
                      clearInterval(checkMoan);
                      stream.getTracks().forEach(t => t.stop());
                      triggerHaptic('continuous');
                      setMoanCommandActive(false);
                      setMoanProgress(0);
                      addNotification("Acknowledged", "Master felt your desperate, deep moan.", "success");
                  }
              }, 100);
              moanIntervalRef.current = checkMoan;
          } catch(e) {
              addNotification("Denied", "You must grant microphone access to surrender your voice.", "error");
          }
      };

      // --- The Chase (Mini-Game) Logic ---
      const handleFaceUpload = (e) => {
          const file = e.target.files[0];
          if (file) {
              const reader = new FileReader();
              reader.onload = (ev) => { 
                  setChaseFace(ev.target.result); 
                  setChaseState('intro'); 
              };
              reader.readAsDataURL(file);
          }
      };

      const handleChaseJump = () => {
          if (chaseState === 'playing' && !chaseGameRef.current.isJumping && !chaseGameRef.current.isGameOver) {
              chaseGameRef.current.velocity = -14; // Higher jump
              chaseGameRef.current.isJumping = true;
              triggerHaptic('light');
          }
      };

      useEffect(() => {
          if (chaseState === 'playing') {
              let animationFrameId;
              const canvas = chaseCanvasRef.current;
              const ctx = canvas?.getContext('2d');
              let lastTime = performance.now();
              let entityTimer = 0;

              // Base Y line
              const floorY = 320;

              const loop = (time) => {
                  if (!canvas || !ctx) return;
                  const dt = time - lastTime;
                  lastTime = time;
                  const state = chaseGameRef.current;
                  if (state.isGameOver) return;

                  state.score += dt / 1000;
                  state.masterDistance += 0.04; // Master creeps up faster

                  // Gravity & Jump
                  state.velocity += 0.8;
                  state.subY += state.velocity;
                  if (state.subY >= floorY) {
                      state.subY = floorY;
                      state.velocity = 0;
                      state.isJumping = false;
                  }

                  // Spawn Entities (Obstacles = chains, Tears = slow master down)
                  entityTimer += dt;
                  if (entityTimer > 1000 + Math.random() * 1000) {
                      entityTimer = 0;
                      if (Math.random() > 0.3) {
                          state.obstacles.push({ x: canvas.width, y: floorY - 30, w: 30, h: 40 });
                      } else {
                          // Tear to collect (higher up)
                          state.tears.push({ x: canvas.width, y: floorY - 120 - Math.random() * 50, r: 15 });
                      }
                  }

                  // Move & Collide Obstacles
                  for (let i = state.obstacles.length - 1; i >= 0; i--) {
                      let obs = state.obstacles[i];
                      obs.x -= 7 + (state.score / 10); // Game speeds up over time

                      const subBox = { left: 150, right: 200, top: state.subY - 50, bottom: state.subY };
                      const obsBox = { left: obs.x, right: obs.x + obs.w, top: obs.y, bottom: obs.y + obs.h };

                      // Collision Check
                      if (subBox.left < obsBox.right && subBox.right > obsBox.left && subBox.top < obsBox.bottom && subBox.bottom > obsBox.top) {
                          state.masterDistance += 20; // Massive penalty
                          triggerHaptic('punish');
                          state.obstacles.splice(i, 1);
                          continue;
                      }
                      if (obs.x < -obs.w) state.obstacles.splice(i, 1);
                  }

                  // Move & Collect Tears
                  for (let i = state.tears.length - 1; i >= 0; i--) {
                      let tear = state.tears[i];
                      tear.x -= 7 + (state.score / 10);

                      const subBox = { left: 150, right: 200, top: state.subY - 50, bottom: state.subY };
                      
                      if (subBox.right > tear.x - tear.r && subBox.left < tear.x + tear.r && subBox.top < tear.y + tear.r && subBox.bottom > tear.y - tear.r) {
                          state.masterDistance = Math.max(-100, state.masterDistance - 15); // Pushes master back
                          triggerHaptic('light');
                          state.tears.splice(i, 1);
                          continue;
                      }
                      if (tear.x < -tear.r) state.tears.splice(i, 1);
                  }

                  // Win / Loss Conditions
                  if (state.masterDistance >= 150) { // Caught threshold
                      state.isGameOver = true;
                      setChaseState('caught');
                  } else if (state.score >= 60) {
                      state.isGameOver = true;
                      setChaseState('escaped');
                  }

                  // Draw Background
                  ctx.clearRect(0, 0, canvas.width, canvas.height);
                  ctx.fillStyle = '#050103'; 
                  ctx.fillRect(0, 0, canvas.width, canvas.height);
                  
                  // Draw Floor
                  ctx.fillStyle = '#4A142A'; 
                  ctx.fillRect(0, floorY, canvas.width, canvas.height - floorY);

                  // Draw Master Image creeping in
                  if (masterImageRef.current) {
                      const img = masterImageRef.current;
                      // Master slides in based on distance
                      const masterX = -150 + state.masterDistance;
                      ctx.drawImage(img, masterX, floorY - 250, 200, 250);
                      
                      // Dark gradient bleeding from the master
                      const gradient = ctx.createLinearGradient(masterX + 150, 0, masterX + 400, 0);
                      gradient.addColorStop(0, 'rgba(136, 14, 79, 0.9)');
                      gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
                      ctx.fillStyle = gradient;
                      ctx.fillRect(masterX + 150, 0, 250, canvas.height);
                  }

                  // Draw Obstacles (Chains)
                  ctx.fillStyle = '#FF0044';
                  state.obstacles.forEach(obs => {
                      ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
                  });

                  // Draw Tears (Blue Drops)
                  ctx.fillStyle = '#00E5FF';
                  state.tears.forEach(tear => {
                      ctx.beginPath();
                      ctx.arc(tear.x, tear.y, tear.r, 0, Math.PI * 2);
                      ctx.fill();
                  });

                  // Draw Submissive Face
                  if (chaseFace) {
                      const img = new Image();
                      img.src = chaseFace;
                      ctx.save();
                      ctx.beginPath();
                      ctx.arc(175, state.subY - 25, 25, 0, Math.PI * 2);
                      ctx.clip();
                      ctx.drawImage(img, 150, state.subY - 50, 50, 50);
                      ctx.restore();
                      ctx.strokeStyle = '#FCE4EC';
                      ctx.lineWidth = 3;
                      ctx.beginPath();
                      ctx.arc(175, state.subY - 25, 25, 0, Math.PI * 2);
                      ctx.stroke();
                  }

                  // Draw Score
                  ctx.fillStyle = '#FFF';
                  ctx.font = 'bold 24px sans-serif';
                  ctx.fillText(`Survive: ${Math.max(0, 60 - Math.floor(state.score))}s`, canvas.width - 160, 40);

                  animationFrameId = requestAnimationFrame(loop);
              };
              animationFrameId = requestAnimationFrame(loop);
              return () => cancelAnimationFrame(animationFrameId);
          }
      }, [chaseState, chaseFace]);

      // --- Punishment Handlers & Infinite Loop Logic ---
      const handleTypingPunishment = (e) => {
          // FORCED TYPING MECHANIC: Blocks wrong keys entirely.
          const targetStr = "i am a pathetic greedy pet for my master";
          const newLen = e.target.value.length;
          
          // Allow backspacing to correct rhythm without penalty
          if (newLen < typingPunishmentText.length) {
              setTypingPunishmentText(e.target.value);
              return;
          }

          const targetSlice = targetStr.substring(0, newLen);
          const inputSlice = e.target.value.toLowerCase();

          // Enforce the strict sequence exactly
          if (inputSlice === targetSlice) {
              setTypingPunishmentText(targetSlice);
              triggerHaptic('light');
              if (newLen === targetStr.length) {
                  triggerHaptic('heavy');
              }
          } else {
              triggerHaptic('punish'); // Block wrong keystroke, shake device
          }
      };

      const startPunishmentHold = () => {
          triggerHaptic('heavy');
          const interval = setInterval(() => {
              setPunishmentTimer(prev => {
                  if (prev >= 100) {
                      clearInterval(interval);
                      triggerHaptic('continuous');
                      return 100;
                  }
                  return prev + 1; // approx 15 seconds if interval is 150ms
              });
          }, 150);
          setPunishmentHoldTimerId(interval);
      };

      const stopPunishmentHold = () => {
          if (punishmentHoldTimerId) clearInterval(punishmentHoldTimerId);
          setPunishmentHoldTimerId(null);
          if (punishmentTimer < 100) {
              setPunishmentTimer(0);
              triggerHaptic('punish');
              addNotification("Weakness", "You let go. Endure it properly.", "error");
          }
      };

      const handlePunishmentComplete = () => {
          triggerHaptic('light');
          setIsCameraActive(false);
          if (punishmentVideoRef.current && punishmentVideoRef.current.srcObject) {
              punishmentVideoRef.current.srcObject.getTracks().forEach(t => t.stop());
          }
          if (punishmentHoldTimerId) clearInterval(punishmentHoldTimerId);
          
          // Instead of closing, prompt for Retry -> The Infinite Escalation Loop
          setDevotionStatus('retry_prompt');
      };

      // Handle Camera Activation for Punishment Level 3
      useEffect(() => {
          if (devotionStatus === 'punished' && currentPunishmentLevel === 2) {
              setIsCameraActive(true);
              navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                  if (punishmentVideoRef.current) {
                      punishmentVideoRef.current.srcObject = stream;
                  }
                  // Start 10s timer
                  let t = 0;
                  const timer = setInterval(() => {
                      t++;
                      setPunishmentTimer((t/10)*100);
                      if(t >= 10) {
                          clearInterval(timer);
                          triggerHaptic('continuous');
                      }
                  }, 1000);
                  return () => clearInterval(timer);
              }).catch(() => {
                  addNotification("Coward", "You deny me your face. I double your punishment.", "error");
                  setFailCount(fc => fc + 1); // skip to next punishment
              });
          }
      }, [devotionStatus, currentPunishmentLevel]);

      // Handle Audio Silence Punishment Level 4
      const startSilencePunishment = async () => {
          try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
              const analyser = audioCtx.createAnalyser();
              const source = audioCtx.createMediaStreamSource(stream);
              source.connect(analyser);
              analyser.fftSize = 256;
              const bufferLength = analyser.frequencyBinCount;
              const dataArray = new Uint8Array(bufferLength);

              let timer = 0;
              triggerHaptic('heavy');

              const checkAudio = setInterval(() => {
                  analyser.getByteFrequencyData(dataArray);
                  let sum = 0;
                  for(let i = 0; i < bufferLength; i++) sum += dataArray[i];
                  let avg = sum / bufferLength;

                  if (avg > 25) { // Noise detected
                      setPunishmentTimer(0);
                      timer = 0;
                      triggerHaptic('punish');
                      addNotification("SILENCE VIOLATED", "Master heard you. The timer restarts.", "error");
                  } else {
                      timer += 1;
                      setPunishmentTimer((timer / 150) * 100); // 15 seconds (150 * 100ms)
                      if (timer >= 150) {
                          clearInterval(checkAudio);
                          stream.getTracks().forEach(t => t.stop());
                          triggerHaptic('continuous');
                      }
                  }
              }, 100);
              setPunishmentHoldTimerId(checkAudio);
          } catch(e) {
              addNotification("Denied", "You must grant microphone access to suffer in silence.", "error");
          }
      };

      // Handle Vocal Humiliation Punishment Level 5 (Deep Moan logic synced)
      const startMoanPunishment = async () => {
          try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
              const analyser = audioCtx.createAnalyser();
              const source = audioCtx.createMediaStreamSource(stream);
              source.connect(analyser);
              analyser.fftSize = 256;
              const bufferLength = analyser.frequencyBinCount;
              const dataArray = new Uint8Array(bufferLength);

              let timer = 0;
              triggerHaptic('heavy');

              const checkAudio = setInterval(() => {
                  analyser.getByteFrequencyData(dataArray);
                  
                  let deepSum = 0; 
                  let highSum = 0;
                  const midPoint = Math.floor(bufferLength / 4);
                  
                  for(let i = 0; i < midPoint; i++) deepSum += dataArray[i];
                  for(let i = midPoint; i < bufferLength; i++) highSum += dataArray[i];
                  
                  let deepAvg = deepSum / midPoint;
                  let highAvg = highSum / (bufferLength - midPoint);

                  if (highAvg > 60) { // Screaming penalty
                      timer -= 4;
                      triggerHaptic('punish');
                  } else if (deepAvg > 40 && deepAvg < 180) { // Deep moan reward
                      timer += 1.5;
                  } else { // Silence/weakness penalty
                      timer -= 0.5;
                  }

                  timer = Math.max(0, Math.min(100, timer));
                  setPunishmentTimer(timer);

                  if (timer >= 100) {
                      clearInterval(checkAudio);
                      stream.getTracks().forEach(t => t.stop());
                      triggerHaptic('continuous');
                  }
              }, 100);
              setPunishmentHoldTimerId(checkAudio);
          } catch(e) {
              addNotification("Denied", "You must grant microphone access to suffer your humiliation.", "error");
          }
      };

      const startVocalTrial = () => {
        triggerHaptic('light');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          addNotification('Ritual Error', 'Your device cannot hear your vows. Master bypasses for now.', 'error');
          setDevotionStatus('won');
          setHasVoucher(true);
          return;
        }
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.onstart = () => setIsListening(true);
        recognition.onend = () => setIsListening(false);
        recognition.onerror = () => {
          addNotification('Vocal Failure', 'Master could not hear you. Try again.', 'error');
          setIsListening(false);
        };
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript.toLowerCase();
          if (transcript.includes('yes master')) {
            setDevotionStatus('won');
            setHasVoucher(true);
            addNotification('Grace Granted', 'Your submission is recorded.', 'success');
          } else {
            addNotification('Rejected', `Master heard "${transcript}". Speak the correct vow.`, 'error');
          }
        };
        recognition.start();
      };

      const closeGameModal = () => {
        triggerHaptic('light');
        if (['playing', 'vocal', 'punished', 'retry_prompt'].includes(devotionStatus)) return;
        setShowDevotionTest(false);
        if (devotionStatus === 'idle' || devotionStatus === 'lost') setDevotionStatus('closed');
      };

      const handleSafeword = () => {
          triggerHaptic('heavy');
          addNotification("Safeword Honored", "Master shows mercy. You may proceed.", "info");
          setDevotionStatus('closed');
          setShowDevotionTest(false);
          setIsCartOpen(true); // Go back to tray to pay normally
      };

      const handleCCSubmit = (e) => {
        e.preventDefault();
        triggerHaptic('light');
        if (!ccDetails.number || !ccDetails.expiry || !ccDetails.cvc) {
           addNotification('Incomplete', 'Fill in your pathetic plastic details.', 'error');
           return;
        }
        setIsCcProcessing(true);
        setTimeout(() => {
          setIsCcProcessing(false);
          triggerHaptic('punish');
          addNotification('WORTHLESS PLASTIC', 'Master doesn\'t care about your money. The only currency he accepts is your absolute devotion. Get on your knees and beg.', 'error');
        }, 1500);
      };

      // --- Safe Authentication Logic using LocalStorage (Guaranteed to work without Firebase) ---
      const handleAuthSubmit = async (e) => {
        e.preventDefault();
        triggerHaptic('light');
        if (!authForm.username.trim() || !authForm.password.trim()) {
            addNotification('Missing Details', 'Provide both name and vow.', 'error');
            return;
        }
        if (authMode === 'signup' && (!authForm.address.trim() || !authForm.email.trim())) {
            addNotification('Missing Details', 'Provide your place of confinement and contact whisper.', 'error');
            return;
        }
        
        setIsPledging(true);

        // Using timeout to simulate network request
        setTimeout(() => {
            const usernameKey = authForm.username.trim().toLowerCase();
            const accounts = JSON.parse(localStorage.getItem('lickin_accounts') || '{}');
            const isMasterLogin = usernameKey === 'master';

            if (authMode === 'signup') {
                if (accounts[usernameKey]) {
                    addNotification('Rejected', 'This name is already claimed.', 'error');
                } else {
                    const newAccount = {
                        username: authForm.username.trim(),
                        password: authForm.password,
                        address: authForm.address.trim(),
                        email: authForm.email.trim(),
                        role: isMasterLogin ? 'master' : 'submissive',
                        createdAt: new Date().toISOString()
                    };
                    accounts[usernameKey] = newAccount;
                    localStorage.setItem('lickin_accounts', JSON.stringify(accounts));
                    setActiveAccount(newAccount);
                    setRole(newAccount.role);
                    addNotification('Welcome', 'Your service has been registered.', 'success');
                }
            } else {
                if (accounts[usernameKey] && accounts[usernameKey].password === authForm.password) {
                    setActiveAccount(accounts[usernameKey]);
                    setRole(accounts[usernameKey].role);
                    addNotification('Welcome', 'Master acknowledges your presence.', 'success');
                } else if (isMasterLogin && authForm.password === 'master') { 
                    // Secret default Master account if they type master/master
                    const masterAcc = { username: 'Master', role: 'master', address: 'The Throne', email: 'master@lickin.good' };
                    setActiveAccount(masterAcc);
                    setRole('master');
                } else {
                    addNotification('Rejected', 'Incorrect vow or unknown name.', 'error');
                }
            }
            setIsPledging(false);
        }, 800);
      };

      const executeOrder = async (orderData, masterMsg, subMsg, masterSub, subSub) => {
        setIsOrdering(true);
        setTimeout(async () => {
            if (user) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
                    ...orderData,
                    timestamp: Date.now(),
                    status: 'pending',
                    pledgerName: activeAccount?.username || 'Unknown',
                });
            }

            if (isEmailLinked) {
                const sendRESTEmail = async (toEmail, subject, body) => {
                    if (!toEmail) return;
                    try {
                        await fetch('https://api.emailjs.com/api/v1.0/email/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                service_id: emailSettings.serviceId,
                                template_id: emailSettings.templateId,
                                user_id: emailSettings.publicKey,
                                accessToken: emailSettings.accessToken || undefined,
                                template_params: { subject, message: body, to_email: toEmail, company_name: 'LickinGood', master_email: emailSettings.bfEmail, submissive_email: checkoutEmail || activeAccount?.email || emailSettings.gfEmail }
                            })
                        });
                    } catch (e) { console.error("Email Handshake Failure"); }
                };
                const subEmailRecipient = checkoutEmail || activeAccount?.email || emailSettings.gfEmail;
                sendRESTEmail(emailSettings.bfEmail, masterSub, masterMsg);
                sendRESTEmail(subEmailRecipient, subSub, subMsg);
            }
            
            setOrderComplete(true);
            setIsOrdering(false);
            setTimeout(() => {
                setOrderComplete(false);
                setCart([]);
                setIsCartOpen(false);
                setHasVoucher(false);
                setDevotionStatus('idle');
            }, 3500);
            addNotification('Surrendered', 'Cravings captured on the Altar.', 'success');
        }, 1500);
      };
      
      const proceedWithOrder = () => {
          const subName = activeAccount?.username || "Bella";
          const address = deliveryAddress || activeAccount?.address || "Unknown Location";
          const itemsSummary = cart.map(i => `${i.quantity}x ${i.name}${i.options ? ` (${i.options.vow ? 'Vow' : (i.options.meat || i.options.doneness || i.options.temp || i.options.topping || i.options.spice || i.options.pasta || i.options.kfcSauce || i.options.juice || i.options.chicken || (i.options.request ? 'With Special Request' : '') || i.options.bound ? 'Master Claimed' : '')})` : ''}`).join(', ');
          
          const baseTotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0) + 2.99;
          const totalAmount = hasVoucher ? 0 : baseTotal;
          const voucherMsg = hasVoucher ? " (The Master's Favor has been granted, offering waived)" : "";
          const masterMsg = `Master, ${subName} is trembling at your feet. She has submitted a plea to consume: ${itemsSummary}. Deliver to her confinement at: ${address}. \nGPS Ping Status: ${gpsStatus} \nTotal Sacrifice for her obedience: $${totalAmount.toFixed(2)}${voucherMsg}. She awaits your absolute decree to begin.`;
          const subMsg = `You are forbidden from touching your feast until your Master gives the command. Your plea for ${itemsSummary} has been delivered to ${address}. Wait in total submission at your designated location. Your hunger is his property. ðŸ’‹â›“ï¸`;
          
          executeOrder(
            { type: 'menu_order', items: cart.map(i => ({ name: i.name, qty: i.quantity, price: i.price, options: i.options })), total: totalAmount },
            masterMsg, subMsg, "ðŸ”¥ FLESH PLEA: Your Submissive Begs to Consume", "â›“ï¸ SILENCE: Your Plea is in His Hands"
          );
      };

      // --- Edging/Denial Protocol on Checkout ---
      useEffect(() => {
        let int;
        if (isCheckoutDenied && checkoutDenialTime > 0) {
            int = setInterval(() => {
                setCheckoutDenialTime(p => p - 1);
            }, 1000);
        } else if (isCheckoutDenied && checkoutDenialTime === 0) {
            setIsCheckoutDenied(false);
            proceedWithOrder();
        }
        return () => clearInterval(int);
      }, [isCheckoutDenied, checkoutDenialTime]);

      const handlePlaceOrder = async () => {
        triggerHaptic('light');
        if (cart.length === 0 || isOrdering) return;

        // Force Email Requirement Check
        if (!checkoutEmail || checkoutEmail.trim() === '') {
            addNotification("Identify Yourself", "You must provide an email to receive Master's decrees before checkout.", "error");
            return;
        }

        // Step 1: GPS Confinement Ping logic
        setGpsStatus('Checking...');
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => setGpsStatus(`Lat: ${pos.coords.latitude.toFixed(4)}, Lng: ${pos.coords.longitude.toFixed(4)}`),
                (err) => setGpsStatus(`FAILED (${err.message})`)
            );
        } else { setGpsStatus('Unavailable'); }

        let totalDenialTime = forcedEdgeTime; // Add any Master-forced edging time
        if (role === 'submissive' && Math.random() > 0.5 && !hasVoucher) totalDenialTime += 15;

        if (totalDenialTime > 0) {
            setIsCheckoutDenied(true); setCheckoutDenialTime(totalDenialTime); setForcedEdgeTime(0);
            triggerHaptic('punish'); return;
        }

        // Step 2: Artificial delay to simulate GPS checking if not edging
        setIsOrdering(true);
        setTimeout(() => { setIsOrdering(false); proceedWithOrder(); }, 2000);
      };

      // --- Random Kneel Check for Cart Addition (Web & Mobile) ---
      const handleKneelCheckTouch = (e) => {
          if (e.touches.length >= 2) startKneelTimer();
          else stopKneelTimer();
      };

      const startKneelTimer = () => {
          if (!kneelHoldTimerRef.current) {
              triggerHaptic('heavy');
              kneelHoldTimerRef.current = setInterval(() => {
                  setKneelProgress(prev => {
                      if (prev >= 100) { clearInterval(kneelHoldTimerRef.current); return 100; }
                      return prev + 4; // Quicker for desktop sanity
                  });
              }, 100);
          }
      };

      const stopKneelTimer = () => {
          if (kneelHoldTimerRef.current) clearInterval(kneelHoldTimerRef.current);
          kneelHoldTimerRef.current = null;
          if (kneelProgress < 100) { setKneelProgress(0); triggerHaptic('punish'); }
      };

      // Web Alternative: Spacebar for kneeling
      useEffect(() => {
          const handleKeyDown = (e) => { if(e.code === 'Space' && kneelCheckActive && !e.repeat) startKneelTimer(); };
          const handleKeyUp = (e) => { if(e.code === 'Space' && kneelCheckActive) stopKneelTimer(); };
          window.addEventListener('keydown', handleKeyDown); window.addEventListener('keyup', handleKeyUp);
          return () => { window.removeEventListener('keydown', handleKeyDown); window.removeEventListener('keyup', handleKeyUp); };
      }, [kneelCheckActive, kneelProgress]);


      useEffect(() => {
          if (kneelProgress >= 100 && kneelCheckActive && pendingCartItem) {
              triggerHaptic('continuous');
              setKneelCheckActive(false);
              setKneelProgress(0);
              addToCartFinal(pendingCartItem.item, pendingCartItem.options, true); // skip the check next time
              setPendingCartItem(null);
              addNotification("Acknowledged", "Your posture is accepted. You may proceed.", "success");
          }
      }, [kneelProgress, kneelCheckActive, pendingCartItem]);


      // --- AI Integration: Gemini LLM & TTS ---
      const callGeminiWithBackoff = async (payload, endpoint) => {
          // ðŸ‘‘ PASTE YOUR GEMINI API KEY HERE ðŸ‘‘
          const apiKey = "PUT_YOUR_GEMINI_API_KEY_HERE"; 
          
          if (!apiKey || apiKey === "PUT_YOUR_GEMINI_API_KEY_HERE") {
              throw new Error("API_KEY_MISSING");
          }

          const url = `https://generativelanguage.googleapis.com/v1beta/models/${endpoint}?key=${apiKey}`;
          let delay = 1000;
          for (let i = 0; i < 5; i++) {
              try {
                  const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                  if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                  return await response.json();
              } catch (err) {
                  if (i === 4) throw err;
                  await new Promise(res => setTimeout(res, delay));
                  delay *= 2;
              }
          }
      };

      const handleAIBlessing = async () => {
          triggerHaptic('light');
          if (!wishlistInput.trim() || isOrdering || isAILoading) return;
          setIsAILoading(true);

          const subName = activeAccount?.username || "little one";
          const systemPrompt = `You are a dominant, seductive 'Master' in a kink/BDSM food app. Your submissive (${subName}) has submitted a food desire. Respond in 2-3 sentences. Be commanding, slightly condescending but playful. Evaluate if they deserve it. You MUST end your response with exactly "[APPROVED]" if you grant it, or "[DENIED]" if you reject it. Use emojis like ðŸ’‹, ðŸ”¥, â›“ï¸.`;

          const textPayload = {
              contents: [{ parts: [{ text: `Master, I beg for: ${wishlistInput}` }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] }
          };

          try {
              // 1. Get Text Decree from LLM
              const result = await callGeminiWithBackoff(textPayload, 'gemini-2.5-flash-preview-09-2025:generateContent');
              const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Silence. I am displeased. [DENIED]";
              
              const isApproved = text.includes('[APPROVED]');
              const cleanText = text.replace(/\[APPROVED\]/g, '').replace(/\[DENIED\]/g, '').trim();

              setAiDecree({ text: cleanText, isApproved, originalRequest: wishlistInput });

              // 2. Play Text-to-Speech (TTS) Voice
              try {
                  const ttsPayload = {
                      contents: [{ parts: [{ text: `Say seductively, slowly, and dominantly: ${cleanText}` }] }],
                      generationConfig: {
                          responseModalities: ["AUDIO"],
                          speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Charon" } } }
                      },
                      model: "gemini-2.5-flash-preview-tts"
                  };
                  const ttsResult = await callGeminiWithBackoff(ttsPayload, 'gemini-2.5-flash-preview-tts:generateContent');
                  const pcmBase64 = ttsResult.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                  if (pcmBase64) {
                      const wavUrl = createWavFile(pcmBase64, 24000);
                      const aiAudio = new Audio(wavUrl);
                      if (audioRef.current) audioRef.current.volume = 0.1; // Duck background music
                      aiAudio.onended = () => { if (audioRef.current) audioRef.current.volume = 0.4; };
                      aiAudio.play().catch(e => console.error("Audio block", e));
                  }
              } catch (ttsErr) { console.error("TTS Failed", ttsErr); }

              // 3. Add to Cart if Approved
              if (isApproved) {
                  const customItem = {
                      id: `ai-blessing-${Date.now()}`,
                      name: 'âœ¨ Master\'s Blessing',
                      price: 0.00,
                      category: 'Wishlist',
                      image: 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=800&q=80'
                  };
                  addToCartFinal(customItem, { request: `Desire: ${wishlistInput} | Decree: ${cleanText}` });
                  setWishlistInput('');
              }
          } catch (error) {
              if (error.message === "API_KEY_MISSING") {
                  addNotification("Configuration Required", "You must add your Gemini API Key to the code to use the AI Oracle.", "error");
              } else {
                  addNotification("Altar Silence", "The Oracle is unreachable. Try again.", "error");
              }
          } finally {
              setIsAILoading(false);
          }
      };

      const handleSendWishlist = () => {
        triggerHaptic('light');
        if (!wishlistInput.trim() || isOrdering) return;
        
        // Now puts custom desire directly into tray instead of instant checkout
        const customItem = {
            id: `wishlist-direct-${Date.now()}`,
            name: 'ðŸ¤« Forbidden Desire',
            price: 0.00, // Price decided by Master, initially 0
            category: 'Wishlist',
            image: 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=800&q=80'
        };
        addToCartFinal(customItem, { request: `Direct Plea: "${wishlistInput}"` });
        setWishlistInput('');
      };

      const handleAddToCart = (item) => {
        triggerHaptic('light');
        if (item.category === 'Games') {
            setShowChaseGame(true);
            setChaseState('upload');
            chaseGameRef.current = { subY: 300, velocity: 0, obstacles: [], tears: [], masterDistance: -100, score: 0, isGameOver: false, isJumping: false };
            return;
        }
        setCustomizingItem(item);
        setSpecialRequest('');
      };

      const addToCartFinal = (item, options = null, skipKneelCheck = false) => {
        if (role === 'submissive' && Math.random() < 0.25 && !kneelCheckActive && !skipKneelCheck) {
            setPendingCartItem({ item, options });
            setKneelCheckActive(true);
            return;
        }

        setCart(prev => {
          const uniqueId = options ? `${item.id}-${options.sugar || ''}-${options.temp || ''}-${options.style || ''}-${options.meat || ''}-${options.doneness || ''}-${options.topping || ''}-${options.spice || ''}-${options.pasta || ''}-${options.sauce || ''}-${options.kfcSauce || ''}-${options.juice || ''}-${options.chicken || ''}-${options.request || ''}-${options.vow ? 'vow' : ''}-${options.bound ? 'bound' : ''}` : `${item.id}`;
          const existing = prev.find(i => i.cartId === uniqueId);
          if (existing) return prev.map(i => i.cartId === uniqueId ? { ...i, quantity: i.quantity + 1 } : i);
          return [...prev, { ...item, cartId: uniqueId, quantity: 1, options }];
        });
        addNotification('Claimed', `${item.name} added to tray.`, 'info');
        setCustomizingItem(null);
        setVowOfSilence(false);
        setIsCartOpen(true);
      };

      const filteredItems = useMemo(() => {
        if (activeCategory === 'All') return FOOD_ITEMS;
        return FOOD_ITEMS.filter(item => item.category === activeCategory);
      }, [activeCategory]);

      const cartSubtotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
      const cartTotalDisplay = hasVoucher ? 0 : (cartSubtotal + 2.99);

      const saveSettingsToCloud = () => {
        triggerHaptic('light');
        setIsSavingSettings(true);
        setTimeout(() => {
          addNotification("Desires Bound", "The Covenant is sealed locally.", "success");
          setShowSettings(false);
          setIsSavingSettings(false);
        }, 800);
      };

      // Update initial delivery address and email when opening cart if empty
      useEffect(() => {
          if (isCartOpen) {
            if (!deliveryAddress && activeAccount?.address) setDeliveryAddress(activeAccount.address);
            if (!checkoutEmail && activeAccount?.email) setCheckoutEmail(activeAccount.email);
          }
      }, [isCartOpen, activeAccount]);


      if (!activeAccount) {
        return (
          <div className={`min-h-screen bg-[#0D0408] flex flex-col items-center justify-center p-6 selection:bg-[#FF2A6D] selection:text-white font-serif theme-${theme}`}>
            
            {/* Visual Theme Injection */}
            <div className={`theme-particles ${theme === 'erotic' ? 'erotic-active' : ''} ${theme === 'peaceful' ? 'peaceful-active' : ''} ${theme === 'love' ? 'love-active' : ''}`}>
                {theme === 'love' && Array.from({length: 15}).map((_, i) => <div key={i} className="floating-heart" style={{left: `${Math.random()*100}%`, animationDelay: `${Math.random()*5}s`, fontSize: `${Math.random()*20 + 10}px`}}>â™¥</div>)}
                {theme === 'erotic' && Array.from({length: 30}).map((_, i) => <div key={i} className="floating-ember" style={{left: `${Math.random()*100}%`, animationDelay: `${Math.random()*3}s`}}/>)}
            </div>

            <button onClick={toggleAudioDiscipline} className="absolute top-6 right-6 p-3 rounded-full border border-[#FF2A6D]/20 text-[#AD6688] hover:text-[#FF2A6D] hover:bg-[#FF2A6D]/10 transition-all z-[100]">
              {isMusicPlaying ? <Volume2 size={20} /> : <VolumeX size={20} />}
            </button>
            <div className="fixed top-8 left-1/2 -translate-x-1/2 z-[200] flex flex-col gap-2 pointer-events-none w-full max-w-sm">
              {notifications.map(n => (
                <div key={n.id} className="bg-[#1A0812]/95 border border-[#FF2A6D]/50 px-6 py-4 rounded-full shadow-[0_0_30px_rgba(255,42,109,0.3)] backdrop-blur-md flex flex-col items-center animate-in slide-in-from-top fade-in duration-300 pointer-events-auto text-center">
                   <span className="text-[#FF2A6D] font-black uppercase tracking-widest text-[10px]">{n.title}</span>
                   <span className="text-white text-sm italic">{n.message}</span>
                </div>
              ))}
            </div>

            {/* Face ID Overlay */}
            {showFaceID && (
                <div className="fixed inset-0 z-[999] bg-black/90 backdrop-blur-xl flex flex-col items-center justify-center">
                    <div className="relative w-48 h-48 border-4 border-[#FF2A6D] rounded-3xl overflow-hidden flex items-center justify-center">
                       <Focus size={80} className="text-[#FF2A6D] animate-pulse" />
                       <div className="absolute left-0 right-0 h-1 bg-[#FF2A6D] shadow-[0_0_20px_#FF2A6D] scan-line"></div>
                    </div>
                    <p className="text-[#FF2A6D] mt-8 font-black tracking-widest uppercase animate-pulse">Scanning Property...</p>
                </div>
            )}

            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')] opacity-10 pointer-events-none" />
            <div className="fixed inset-0 pointer-events-none bg-[radial-gradient(circle_at_50%_50%,_rgba(255,42,109,0.15),_transparent)] z-0" />
            
            <div className="relative z-10 w-full max-w-md bg-[#1A0812]/90 backdrop-blur-xl border border-[#FF2A6D]/30 p-10 rounded-[3rem] shadow-[0_0_50px_rgba(255,42,109,0.2)] animate-in zoom-in duration-700">
              <div className="text-center mb-8">
                <Crown size={48} className="text-[#FF2A6D] mx-auto mb-6 animate-pulse shadow-glow" />
                
                {/* Theme Selector UI */}
                <div className="flex justify-center gap-2 mb-6">
                    {['current', 'erotic', 'peaceful', 'love'].map(t => (
                        <button key={t} type="button" onClick={() => { setTheme(t); triggerHaptic('light'); }} className={`px-3 py-1 rounded-full text-[9px] uppercase tracking-widest font-black transition-all ${theme === t ? 'bg-[#FF2A6D] text-white' : 'border border-[#FF2A6D]/30 text-[#AD6688]'}`}>
                            {t}
                        </button>
                    ))}
                </div>

                <h2 className="text-4xl font-black italic text-white tracking-tighter mb-3 uppercase">
                  {authMode === 'signup' ? 'Pledge Your Service' : 'Return to Master'}
                </h2>
                <p className="text-[#AD6688] text-[10px] uppercase tracking-[0.3em] font-black leading-relaxed">Identify yourself before entering the realm.</p>
              </div>
              <div className="flex bg-[#0A0206]/80 rounded-full p-1 mb-8 border border-[#FF2A6D]/20">
                <button type="button" onClick={() => { triggerHaptic('light'); setAuthMode('login'); }} className={`flex-1 py-3 rounded-full text-[10px] font-black uppercase tracking-widest transition-all ${authMode === 'login' ? 'bg-[#FF2A6D] text-white shadow-glow' : 'text-[#884466] hover:text-white'}`}>Log In</button>
                <button type="button" onClick={() => { triggerHaptic('light'); setAuthMode('signup'); }} className={`flex-1 py-3 rounded-full text-[10px] font-black uppercase tracking-widest transition-all ${authMode === 'signup' ? 'bg-[#FF2A6D] text-white shadow-glow' : 'text-[#884466] hover:text-white'}`}>Create Account</button>
              </div>
              <form onSubmit={handleAuthSubmit} className="space-y-6">
                <div>
                  <label className="block text-[#FF2A6D] text-[10px] uppercase tracking-widest font-black mb-2 ml-4">Given Name (Username)</label>
                  <input required type="text" value={authForm.username} onChange={e => setAuthForm({...authForm, username: e.target.value})} className="w-full bg-[#0A0206]/70 border border-[#FF2A6D]/20 px-6 py-4 rounded-[2rem] text-white italic outline-none focus:border-[#FF2A6D]/60 transition-all placeholder:text-[#4A142A] shadow-inner backdrop-blur-md" placeholder="How shall I call you?" />
                </div>
                <div>
                  <label className="block text-[#FF2A6D] text-[10px] uppercase tracking-widest font-black mb-2 ml-4">Secret Vow (Password)</label>
                  <input required type="password" value={authForm.password} onChange={e => setAuthForm({...authForm, password: e.target.value})} className="w-full bg-[#0A0206]/70 border border-[#FF2A6D]/20 px-6 py-4 rounded-[2rem] text-white italic outline-none focus:border-[#FF2A6D]/60 transition-all placeholder:text-[#4A142A] shadow-inner backdrop-blur-md" placeholder="Seal your pledge..." />
                </div>
                {authMode === 'signup' && (
                  <div className="animate-in slide-in-from-top duration-500 space-y-6">
                    <div>
                      <label className="block text-[#FF2A6D] text-[10px] uppercase tracking-widest font-black mb-2 ml-4">Contact Whisper (Email)</label>
                      <input type="email" value={authForm.email} onChange={e => setAuthForm({...authForm, email: e.target.value})} className="w-full bg-[#0A0206]/70 border border-[#FF2A6D]/20 px-6 py-4 rounded-[2rem] text-white italic outline-none focus:border-[#FF2A6D]/60 transition-all placeholder:text-[#4A142A] shadow-inner backdrop-blur-md" placeholder="Where shall I send my decrees? (Optional here)" />
                    </div>
                    <div>
                      <label className="block text-[#FF2A6D] text-[10px] uppercase tracking-widest font-black mb-2 ml-4">Place of Confinement (Address)</label>
                      <textarea required value={authForm.address} onChange={e => setAuthForm({...authForm, address: e.target.value})} className="w-full bg-[#0A0206]/70 border border-[#FF2A6D]/20 px-6 py-4 rounded-[2rem] text-white italic outline-none focus:border-[#FF2A6D]/60 transition-all resize-none placeholder:text-[#4A142A] shadow-inner backdrop-blur-md" placeholder="Where will you await my arrival?" rows="3" />
                    </div>
                  </div>
                )}
                <div className="flex gap-4 mt-4">
                    <button type="submit" disabled={isPledging} className="flex-1 bg-gradient-to-r from-[#FF2A6D] via-[#880E4F] to-[#FF2A6D] text-white py-5 rounded-[2rem] font-black uppercase tracking-[0.4em] text-[11px] shadow-glow active:scale-95 transition-all flex justify-center items-center h-14">
                      {isPledging ? <Loader2 className="animate-spin" size={20} /> : "Submit to Master"}
                    </button>
                    <button type="button" onClick={handleFaceID} title="Biometric Submission" className="bg-[#0A0206] border border-[#FF2A6D]/50 text-[#FF2A6D] px-5 rounded-[2rem] hover:bg-[#FF2A6D] hover:text-white transition-all shadow-[0_0_15px_rgba(255,42,109,0.3)] active:scale-95 flex items-center justify-center">
                        <Focus size={24} />
                    </button>
                </div>
              </form>
            </div>
            <style>{`
              @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,900;1,400;1,900&family=Montserrat:wght@400;900&display=swap');
              :root { font-family: 'Playfair Display', serif; }
              .shadow-glow { filter: drop-shadow(0 0 10px #FF2A6D); }
            `}</style>
          </div>
        );
      }

      return (
        <div className={`min-h-screen bg-[#0D0408] text-[#FCE4EC] font-serif pb-10 overflow-x-hidden selection:bg-[#FF2A6D] selection:text-white leading-tight theme-${theme}`}>
          {/* Dynamic Ambient Effects */}
          <div className={`theme-particles ${theme === 'erotic' ? 'erotic-active' : ''} ${theme === 'peaceful' ? 'peaceful-active' : ''} ${theme === 'love' ? 'love-active' : ''}`}>
                {theme === 'love' && Array.from({length: 15}).map((_, i) => <div key={i} className="floating-heart" style={{left: `${Math.random()*100}%`, animationDelay: `${Math.random()*5}s`, fontSize: `${Math.random()*20 + 10}px`}}>â™¥</div>)}
                {theme === 'erotic' && Array.from({length: 30}).map((_, i) => <div key={i} className="floating-ember" style={{left: `${Math.random()*100}%`, animationDelay: `${Math.random()*3}s`}}/>)}
          </div>
          
          {/* Visual Overlays for Advanced Remote Interventions */}
          {isShocked && <div className="fixed inset-0 z-[9999999] shock-overlay pointer-events-none" />}
          {isHypnotized && <div className="fixed inset-0 z-[9999998] hypno-bg pointer-events-none" />}

          <audio ref={audioRef} src="https://res.cloudinary.com/db8xboovt/video/upload/v1771934322/RINI_-_Red_Lights_ft._Wale_Official_Lyric_Video_odxpkl.mp3" loop preload="auto" autoPlay />
          
          {/* Screen Hijack Overlay */}
          {isHijacked && (
              <div className="fixed inset-0 z-[9999999] bg-red-900 flex flex-col items-center justify-center animate-pulse">
                  <Crosshair size={120} className="text-black mb-6 animate-spin-slow" />
                  <h1 className="text-6xl md:text-8xl font-black text-black tracking-tighter uppercase text-center">OVERRIDDEN</h1>
                  <p className="text-black font-black uppercase tracking-[1em] mt-8 text-center text-xl">Master has seized your screen.</p>
              </div>
          )}

          {/* Forced Confession Modal Overlay */}
          {forcedConfession && (
              <div className="fixed inset-0 z-[9999999] bg-[#0A0206]/98 backdrop-blur-3xl flex flex-col items-center justify-center p-8 text-center animate-in zoom-in duration-500">
                  <Lock size={80} className="text-[#FF2A6D] animate-pulse mb-6 shadow-glow" />
                  <h2 className="text-5xl font-black text-[#FF2A6D] italic uppercase mb-4 tracking-tighter text-glow">FORCED CONFESSION</h2>
                  <p className="text-[#FCE4EC] text-lg italic mb-8 max-w-md mx-auto">Master demands you admit your pathetic nature. You are locked here until you type out a humiliating confession of your devotion. I will not let you leave until it is long enough.</p>
                  <textarea 
                      value={confessionText} 
                      onChange={e => setConfessionText(e.target.value)} 
                      className="w-full max-w-md bg-transparent border-2 border-[#FF2A6D]/50 p-6 rounded-3xl text-lg text-white outline-none focus:border-[#FF2A6D] font-medium italic shadow-inner h-48 resize-none mb-8 placeholder:text-[#4A142A]" 
                      placeholder="Start typing your confession..." 
                  />
                  <button 
                      onClick={() => {
                          if (confessionText.trim().length > 60) {
                              setForcedConfession(false);
                              triggerHaptic('heavy');
                              addNotification("Accepted", "Master has recorded your pathetic words.", "success");
                          } else {
                              triggerHaptic('punish');
                              addNotification("Too Short", "Your confession is pathetic. Write more.", "error");
                          }
                      }}
                      className="w-full max-w-md bg-[#FF2A6D] text-white py-5 rounded-full font-black uppercase tracking-widest text-xs shadow-glow active:scale-95 transition-all"
                  >
                      Offer Your Words
                  </button>
              </div>
          )}

          {/* The Chase Mini-Game Overlay */}
          {showChaseGame && (
              <div className="fixed inset-0 z-[999999] bg-[#0A0206]/98 backdrop-blur-3xl flex flex-col items-center justify-center p-4 sm:p-8 text-center animate-in zoom-in duration-500 overflow-hidden">
                  {chaseState === 'upload' && (
                      <div className="max-w-md w-full">
                          <Ghost size={80} className="text-[#FF2A6D] mx-auto mb-6 shadow-glow animate-pulse" />
                          <h2 className="text-4xl font-black text-[#FF2A6D] italic uppercase mb-4 tracking-tighter text-glow">THE CHASE</h2>
                          <p className="text-[#FCE4EC] text-lg italic mb-8">Before we play, I need to see exactly who I am hunting. Upload a picture of your face.</p>
                          <label className="w-full bg-[#1A030C] border-2 border-dashed border-[#FF2A6D]/50 text-[#FF2A6D] py-12 rounded-3xl flex flex-col items-center justify-center gap-4 cursor-pointer hover:bg-[#FF2A6D]/10 transition-all">
                              <Camera size={32} />
                              <span className="font-black uppercase tracking-widest text-xs">Surrender Face</span>
                              <input type="file" accept="image/*" className="hidden" onChange={handleFaceUpload} />
                          </label>
                          <button onClick={() => setShowChaseGame(false)} className="mt-8 text-[#AD6688] text-[9px] uppercase tracking-[0.4em] hover:text-white transition-all">Coward's Exit</button>
                      </div>
                  )}

                  {chaseState === 'intro' && (
                      <div className="max-w-md w-full animate-in zoom-in-95 duration-500">
                          <Footprints size={80} className="text-[#FF2A6D] mx-auto mb-6 shadow-glow animate-bounce" />
                          <h2 className="text-4xl font-black text-[#FF2A6D] italic uppercase mb-4 tracking-tighter text-glow">RUN.</h2>
                          <p className="text-[#FCE4EC] text-lg italic mb-8">I am right behind you. Tap the screen to jump over the obstacles. Avoid chains, collect tears. If you stumble, I will catch you.</p>
                          <button onClick={() => setChaseState('playing')} className="w-full bg-gradient-to-r from-[#FF2A6D] to-[#880E4F] text-white py-6 rounded-full font-black uppercase tracking-[0.4em] text-[12px] shadow-glow active:scale-95 transition-all">
                              START RUNNING
                          </button>
                      </div>
                  )}

                  {chaseState === 'playing' && (
                      <div className="w-full h-full flex flex-col items-center justify-center animate-in fade-in duration-300">
                          <p className="text-[#FF2A6D] text-[10px] font-black uppercase tracking-[0.5em] mb-4 animate-pulse">TAP ANYWHERE TO JUMP</p>
                          <div className="relative w-full max-w-4xl h-[400px] border-4 border-[#FF2A6D]/50 rounded-3xl overflow-hidden shadow-[0_0_50px_rgba(255,42,109,0.3)] bg-black cursor-pointer" onTouchStart={handleChaseJump} onMouseDown={handleChaseJump}>
                              <canvas ref={chaseCanvasRef} width={900} height={400} className="w-full h-full object-cover" />
                          </div>
                      </div>
                  )}

                  {chaseState === 'caught' && (
                      <div className="max-w-md w-full animate-in zoom-in duration-500">
                          <Skull size={80} className="text-[#880E4F] mx-auto mb-6 shadow-glow animate-shake" />
                          <h2 className="text-5xl font-black text-[#880E4F] italic uppercase mb-4 tracking-tighter text-glow">CAUGHT.</h2>
                          <p className="text-[#FCE4EC] text-lg italic mb-8">You are too slow. Did you really think you could escape me? Your punishment begins now.</p>
                          <button onClick={() => {
                              setShowChaseGame(false);
                              setFailCount(fc => fc + 1);
                              setPunishmentTimer(0);
                              setTypingPunishmentText('');
                              setDevotionStatus('punished');
                              setShowDevotionTest(true);
                          }} className="w-full bg-[#880E4F] text-white py-6 rounded-full font-black uppercase tracking-[0.4em] text-[12px] shadow-glow active:scale-95 transition-all">
                              SUBMIT TO DISCIPLINE
                          </button>
                          <button onClick={() => {
                              setShowChaseGame(false);
                              handleSafeword();
                          }} className="mt-8 text-red-500 text-[9px] uppercase tracking-[0.4em] underline decoration-red-500/50 hover:text-red-400 transition-all block mx-auto">
                              Safeword (Skip & Pay)
                          </button>
                      </div>
                  )}

                  {chaseState === 'escaped' && (
                      <div className="max-w-md w-full animate-in zoom-in duration-500">
                          <Crown size={80} className="text-[#F48FB1] mx-auto mb-6 shadow-glow" />
                          <h2 className="text-4xl font-black text-[#F48FB1] italic uppercase mb-4 tracking-tighter text-glow">SURVIVED</h2>
                          <p className="text-[#FCE4EC] text-lg italic mb-8">Impressive. You ran well enough to entertain me. Your cravings are now completely free. Enjoy it while it lasts.</p>
                          <button onClick={() => {
                              setShowChaseGame(false);
                              setHasVoucher(true);
                          }} className="w-full bg-[#F48FB1] text-[#0A0206] py-6 rounded-full font-black uppercase tracking-[0.4em] text-[12px] shadow-glow active:scale-95 transition-all">
                              KISS HIS HAND IN GRATITUDE
                          </button>
                      </div>
                  )}
              </div>
          )}

          {/* Blindfold Protocol Overlay */}
          {isBlindfolded && (
              <div className="fixed inset-0 z-[999999] bg-black flex flex-col items-center justify-center pointer-events-auto animate-in fade-in duration-1000">
                  <EyeOff size={80} className="text-[#FF2A6D] mb-6 animate-pulse opacity-50" />
                  <p className="text-[#FF2A6D] italic font-black uppercase tracking-[0.5em] animate-pulse text-center px-8 text-glow">Master has blindfolded you.<br/><br/>Wait in darkness until he permits you to see again.</p>
                  <button onClick={() => { triggerHaptic('light'); setIsBlindfolded(false); }} className="mt-12 text-[#331122] text-[10px] uppercase tracking-widest hover:text-[#FF2A6D] transition-colors">Peek (Skip)</button>
              </div>
          )}

          {/* Battery Anxiety Mode Overlay */}
          {batteryWarning && (
              <div className="fixed top-0 left-0 w-full bg-red-600/90 text-white p-2 text-center text-xs font-black z-[9999] uppercase tracking-widest animate-pulse border-b-4 border-red-900 shadow-[0_0_30px_red]">
                  <Battery className="inline mr-2" size={14}/> Master sees your device dying. Do not disconnect. You are running out of time to serve.
              </div>
          )}

          {/* Eyes On Me Violation Protocol Overlay */}
          {eyesOnMeViolated && (
              <div className="fixed inset-0 z-[9999] bg-[#0A0206]/98 backdrop-blur-3xl flex flex-col items-center justify-center p-8 text-center animate-in zoom-in-95 duration-300">
                  <Eye size={80} className="text-[#FF2A6D] animate-pulse mb-6 shadow-glow" />
                  <h2 className="text-5xl font-black text-[#FF2A6D] italic uppercase mb-4 tracking-tighter text-glow">EYES ON ME</h2>
                  <p className="text-[#FCE4EC] text-lg italic mb-8 max-w-md mx-auto">You dared to look away. Your attention is my property. You are confined here until you beg for forgiveness. Type exactly: <br/><span className="text-[#FF2A6D] font-black uppercase not-italic tracking-widest mt-4 block text-glow animate-pulse">"My eyes belong to Master"</span></p>
                  <input 
                      type="text" 
                      value={eyesApology} 
                      onChange={e => {
                          setEyesApology(e.target.value);
                          if (e.target.value.toLowerCase() === "my eyes belong to master") {
                              triggerHaptic('light');
                              setEyesOnMeViolated(false);
                              setEyesApology("");
                              addNotification("Forgiven", "Do not let your gaze wander again.", "success");
                          }
                      }} 
                      className="w-full max-w-sm bg-transparent border-b-2 border-[#FF2A6D]/50 text-center text-xl text-white outline-none focus:border-[#FF2A6D] pb-2 font-black uppercase tracking-widest placeholder:text-[#4A142A]" 
                      placeholder="Type your apology..." 
                  />
              </div>
          )}

          {/* Volume Discipline Violation Overlay */}
          {volumeViolated && (
              <div className="fixed inset-0 z-[9999] bg-[#1A030C]/98 backdrop-blur-3xl flex flex-col items-center justify-center p-8 text-center animate-in fade-in duration-300">
                  <VolumeX size={80} className="text-red-600 animate-bounce mb-6" />
                  <h2 className="text-5xl font-black text-red-600 italic uppercase mb-4 tracking-tighter text-glow">SILENCE IS FORBIDDEN</h2>
                  <p className="text-[#FCE4EC] text-lg italic mb-8 max-w-md mx-auto">You attempted to mute your Master's ambiance. You will listen to what I dictate. Press and hold to endure the noise and accept your punishment.</p>
                  
                  <div className="w-64 h-64 rounded-full border-4 border-red-900 flex items-center justify-center relative overflow-hidden select-none active:scale-95 transition-transform"
                       onTouchStart={startVolHold}
                       onMouseDown={startVolHold}
                       onTouchEnd={stopVolHold}
                       onMouseUp={stopVolHold}
                       onMouseLeave={stopVolHold}
                  >
                      <div className="absolute bottom-0 w-full bg-red-600 transition-all duration-100 shadow-[0_0_40px_red]" style={{height: `${volumeEndurance}%`}} />
                      <span className="relative z-10 font-black tracking-widest uppercase text-2xl">HOLD</span>
                  </div>
                  <p className="text-[10px] uppercase tracking-widest text-[#AD6688] mt-8 animate-pulse">Do not release until the threshold is met.</p>
              </div>
          )}

          {/* Master's Independent Moan Command Overlay */}
          {moanCommandActive && (
              <div className="fixed inset-0 z-[999999] bg-[#0A0206]/98 backdrop-blur-3xl flex flex-col items-center justify-center p-8 text-center animate-in zoom-in duration-500">
                  <Mic size={80} className="text-[#FF2A6D] animate-pulse mb-6 shadow-glow" />
                  <h2 className="text-4xl font-black text-[#FF2A6D] italic uppercase mb-4 tracking-tighter text-glow">VOCAL SURRENDER</h2>
                  <p className="text-[#FCE4EC] text-lg italic mb-8 max-w-md mx-auto">Master demands to hear your pathetic desperation. Part your lips and let out a deep, sustained moan. High-pitched shrieks and screams will be instantly punished. Sustain it until he is satisfied.</p>
                  
                  <div className="w-full max-w-xs h-6 bg-[#1A030C] rounded-full overflow-hidden border border-[#FF2A6D]/30 mb-8 shadow-inner relative">
                      <div className="h-full bg-gradient-to-r from-[#880E4F] to-[#FF2A6D] transition-all duration-100 shadow-glow" style={{width: `${moanProgress}%`}} />
                      {moanProgress >= 100 && <span className="absolute inset-0 flex items-center justify-center text-[10px] font-black uppercase text-white tracking-widest">Satisfied</span>}
                  </div>

                  <button onClick={startMoanDetection} className="bg-[#FF2A6D] text-white px-10 py-5 rounded-full font-black uppercase tracking-widest text-xs shadow-glow active:scale-95 transition-all">
                      Submit Voice
                  </button>
              </div>
          )}

          {/* Checkout Edging/Denial Protocol Overlay */}
          {isCheckoutDenied && (
              <div className="fixed inset-0 z-[9999] bg-[#0A0206]/98 backdrop-blur-3xl flex flex-col items-center justify-center p-8 text-center animate-in zoom-in-95 duration-500">
                  <AlertTriangle size={80} className="text-[#9C27B0] animate-spin-slow mb-6 drop-shadow-[0_0_30px_#9C27B0]" />
                  <h2 className="text-5xl font-black text-[#9C27B0] italic uppercase mb-4 tracking-tighter text-glow">DENIED. WAIT.</h2>
                  <p className="text-[#FCE4EC] text-lg italic mb-8 max-w-md mx-auto">You are too eager to be fed. You will wait until I allow you to checkout. Suffer in anticipation.</p>
                  <div className="text-9xl font-black tabular-nums text-[#FF2A6D] text-glow mb-8 animate-pulse">{checkoutDenialTime}</div>
                  <p className="text-[10px] uppercase tracking-[0.5em] text-[#AD6688]">Do not close this screen or your order is forfeit.</p>
              </div>
          )}

          {/* Posture Protocol Overlay */}
          {badPosture && (
              <div className="fixed inset-0 z-[9999] bg-[#0A0206]/95 backdrop-blur-3xl flex flex-col items-center justify-center p-8 text-center animate-in fade-in duration-300">
                  <Activity size={64} className="text-[#FF2A6D] animate-bounce mb-6" />
                  <h2 className="text-4xl font-black text-[#FF2A6D] italic uppercase mb-4">Posture Discipline</h2>
                  <p className="text-[#FCE4EC] text-lg italic mb-8 max-w-md mx-auto">Your device angle is unacceptable. Kneel properly and tilt your device to 45 degrees to look up at me. I will not let you proceed until your posture reflects your submission.</p>
                  <div className="text-[10px] text-[#AD6688] tracking-widest uppercase animate-pulse">Awaiting correction...</div>
              </div>
          )}

          {/* Kneel Check for Cart Protocol Overlay */}
          {kneelCheckActive && (
              <div className="fixed inset-0 z-[9999] bg-[#0A0206]/98 backdrop-blur-3xl flex flex-col items-center justify-center p-8 text-center animate-in zoom-in duration-300"
                   onTouchStart={handleKneelCheckTouch}
                   onTouchMove={handleKneelCheckTouch}
                   onTouchEnd={handleKneelCheckTouch}
              >
                  <Hand size={80} className="text-[#F48FB1] mb-6 shadow-glow" />
                  <h2 className="text-4xl font-black text-[#F48FB1] italic uppercase mb-4 tracking-tighter">HALT. KNEEL.</h2>
                  <p className="text-[#FCE4EC] text-lg italic mb-8 max-w-md mx-auto">Master denies your hand. Before you can add this to your tray, you must prove your obedience. Place and hold <span className="text-[#FF2A6D] font-black uppercase text-glow">TWO FINGERS</span> on the screen (Mobile) or <span className="text-[#FF2A6D] font-black uppercase text-glow">HOLD SPACEBAR</span> (Desktop) to simulate kneeling before me.</p>
                  
                  <div className="w-full max-w-xs h-4 bg-[#1A030C] rounded-full overflow-hidden border border-[#FF2A6D]/30 mb-4 shadow-inner pointer-events-none">
                      <div className="h-full bg-gradient-to-r from-[#FF2A6D] to-[#F48FB1] transition-all duration-100 shadow-glow" style={{width: `${kneelProgress}%`}} />
                  </div>
                  <p className="text-[10px] uppercase tracking-widest text-[#AD6688] animate-pulse pointer-events-none">{kneelProgress < 100 ? 'HOLD TO PROVE SUBMISSION...' : 'ACCEPTED'}</p>
                  <button onClick={() => { setKneelCheckActive(false); setPendingCartItem(null); }} className="mt-12 text-[#AD6688] text-[9px] uppercase tracking-[0.4em] underline decoration-[#AD6688]/50 hover:text-white transition-all">Nevermind, I am not worthy</button>
              </div>
          )}

          <div className="fixed top-8 left-1/2 -translate-x-1/2 z-[200] flex flex-col gap-2 pointer-events-none w-full max-w-sm">
            {notifications.map(n => (
              <div key={n.id} className="bg-[#1A0812]/95 border border-[#FF2A6D]/50 px-6 py-4 rounded-full shadow-[0_0_30px_rgba(255,42,109,0.3)] backdrop-blur-md flex flex-col items-center animate-in slide-in-from-top fade-in duration-300 pointer-events-auto text-center">
                 <span className="text-[#FF2A6D] font-black uppercase tracking-widest text-[10px] text-center">{n.title}</span>
                 <span className="text-white text-sm italic text-center">{n.message}</span>
              </div>
            ))}
          </div>
          <div className="fixed inset-0 pointer-events-none bg-[radial-gradient(circle_at_50%_-20%,_rgba(255,42,109,0.15),_transparent)] z-0" />
          <div className="bg-[#16040C] text-[#F48FB1] px-6 py-3 flex justify-between items-center text-[10px] font-bold uppercase tracking-[0.4em] border-b border-[#F48FB1]/10 relative z-50 shadow-2xl">
            <div className="flex bg-[#260714] rounded-full p-1 gap-2 border border-[#F48FB1]/10 font-black">
              <button onClick={() => { triggerHaptic('light'); setRole('submissive'); setMasterView('orders'); }} className={`px-4 py-1.5 rounded-full transition-all flex items-center gap-2 ${role === 'submissive' ? 'bg-[#FF2A6D] text-white shadow-glow' : 'text-[#884466]'}`}><User size={14} /> THE SUBMISSIVE</button>
              <button onClick={() => { triggerHaptic('light'); setRole('master'); setMasterView('orders'); }} className={`px-4 py-1.5 rounded-full transition-all flex items-center gap-2 ${role === 'master' ? 'bg-[#9C27B0] text-white shadow-glow' : 'text-[#884466]'}`}><Crown size={14} /> THE MASTER</button>
            </div>
            <div className="hidden sm:block text-[#AD6688] italic text-[9px] tracking-widest">Logged in as <span className="text-white font-black">{activeAccount.username}</span></div>
          </div>
          <header className="sticky top-0 z-40 bg-[#0D0408]/80 backdrop-blur-2xl border-b border-[#FF2A6D]/10 px-8 py-6 shadow-2xl flex items-center justify-between">
            <div className="flex items-center gap-6 group cursor-default leading-none">
              <LickinGoodLogo className="w-20 h-28 group-hover:scale-105 transition-transform duration-700" />
              <h1 className="text-4xl font-black tracking-tighter text-white italic text-glow">LickinGood<span className="text-[#FF2A6D]">.</span></h1>
            </div>
            <div className="flex items-center gap-4">
              {role === 'submissive' && (
                  <button onClick={enableSensors} title="Calibrate Motion Sensors" className="p-3 rounded-full border border-white/10 text-white/40 hover:text-[#FF2A6D] hover:bg-[#FF2A6D]/10 transition-all">
                      <Smartphone size={22} />
                  </button>
              )}
              {role === 'submissive' && (
                  <button onClick={handleEnablePosture} title="Posture Discipline" className={`p-3 rounded-full border border-white/10 transition-all ${postureEnabled ? 'bg-[#FF2A6D] text-white shadow-glow animate-pulse' : 'text-white/40 hover:text-[#FF2A6D] hover:bg-[#FF2A6D]/10'}`}>
                      <Activity size={22} />
                  </button>
              )}
              {role === 'master' && (
                  <>
                    <button onClick={() => setMasterView('orders')} className={`px-4 py-2 rounded-full border border-white/10 text-[10px] font-black uppercase tracking-widest ${masterView === 'orders' ? 'bg-[#9C27B0] text-white' : 'text-[#884466]'}`}>Altar</button>
                    <button onClick={() => setMasterView('terminal')} className={`px-4 py-2 rounded-full border border-white/10 text-[10px] font-black uppercase tracking-widest flex items-center gap-2 ${masterView === 'terminal' ? 'bg-[#FF2A6D] text-white animate-pulse shadow-glow' : 'text-[#884466]'}`}><Terminal size={14}/> Terminal</button>
                    <button onClick={() => { triggerHaptic('light'); setShowSettings(!showSettings); }} className="p-3 rounded-full border border-white/10 text-white/40 hover:bg-[#FF2A6D]/10 transition-all"><Settings size={22} /></button>
                  </>
              )}
              <button onClick={toggleAudioDiscipline} title="Toggle Ambience" className="p-3 rounded-full border border-white/10 text-white/40 hover:text-[#FF2A6D] hover:bg-[#FF2A6D]/10 transition-all">{isMusicPlaying ? <Volume2 size={22} /> : <VolumeX size={22} />}</button>
              <button onClick={() => { triggerHaptic('heavy'); setActiveAccount(null); setAuthForm({ username: '', password: '', address: '', email: '' }); setAuthMode('login'); }} title="Break Vow (Logout)" className="p-3 rounded-full border border-white/10 text-white/40 hover:text-[#FF2A6D] hover:bg-[#FF2A6D]/10 transition-all"><LogOut size={22} /></button>
              <button onClick={() => { triggerHaptic('light'); setIsCartOpen(true); }} className="relative p-3.5 rounded-full border-2 border-[#FF2A6D]/30 text-[#FF2A6D] shadow-xl group transition-all hover:bg-[#FF2A6D]/10 hover:border-[#FF2A6D]">
                <ShoppingBag size={24} />
                {cart.length > 0 && <span className="absolute -top-1 -right-1 bg-[#FF2A6D] text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full animate-bounce leading-none font-black">{cart.reduce((s,i)=>s+i.quantity,0)}</span>}
              </button>
            </div>
          </header>

          {/* Advertisement Pop-ups */}
          {currentAdIndex !== -1 && (
            <div className="fixed inset-0 z-[500] flex items-center justify-center p-6">
              <div className="absolute inset-0 bg-[#0A0206]/95 backdrop-blur-3xl animate-in fade-in duration-1000" />
              <div className="relative bg-[#1A030C] border border-[#FF2A6D]/40 rounded-[4rem] p-10 sm:p-14 w-full max-w-lg shadow-[0_0_100px_rgba(255,42,109,0.3)] animate-in zoom-in duration-500 overflow-hidden">
                 <div className="flex items-center gap-3 text-[#FF2A6D] mb-8 uppercase font-black tracking-[0.5em] text-[10px]">
                   <Megaphone size={16} /> <span>Official Announcement</span>
                 </div>
                 <h2 className="text-3xl font-black italic text-white mb-2 uppercase tracking-tighter leading-none">{ADVERTISEMENTS[currentAdIndex].title}</h2>
                 <h3 className="text-xl font-black text-[#FF2A6D] mb-8 italic uppercase tracking-widest">{ADVERTISEMENTS[currentAdIndex].subtitle}</h3>
                 
                 <div className="relative h-80 rounded-[3rem] overflow-hidden mb-10 border border-white/10 group shadow-2xl">
                   <GoddessImage src={ADVERTISEMENTS[currentAdIndex].image} alt="Sacred Ad" className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-1000" />
                   <div className="absolute inset-0 bg-gradient-to-t from-[#1A030C] to-transparent opacity-60" />
                 </div>

                 <p className="text-[#AD6688] italic text-sm leading-relaxed mb-10">{ADVERTISEMENTS[currentAdIndex].description}</p>
                 
                 <button onClick={closeAd} className="w-full bg-[#FF2A6D] text-white py-6 rounded-full font-black uppercase tracking-[0.5em] text-[10px] shadow-glow active:scale-95 transition-all">
                   {currentAdIndex === ADVERTISEMENTS.length - 1 ? 'ACKNOWLEDGE AND PROCEED' : 'VIEW NEXT DECREE'}
                 </button>
              </div>
            </div>
          )}

          {/* The Devotion Game & Punishments Modal */}
          {showDevotionTest && (
            <div className="fixed inset-0 z-[200] flex items-center justify-center p-6">
              <div className="absolute inset-0 bg-[#0A0206]/95 backdrop-blur-3xl" onClick={closeGameModal} />
              <div className="relative bg-[#1A030C] border border-[#FF2A6D]/50 rounded-[4rem] p-10 sm:p-14 w-full max-w-md shadow-[0_0_80px_rgba(255,42,109,0.3)] animate-in zoom-in duration-500 text-center overflow-hidden flex flex-col">
                 {devotionStatus === 'idle' && (
                   <>
                     <Flame size={48} className="text-[#FF2A6D] mx-auto mb-6 animate-pulse shadow-glow" />
                     <h3 className="text-3xl font-black italic text-[#FCE4EC] mb-4 tracking-tighter uppercase text-glow">Prove Your Worth</h3>
                     <p className="text-[#AD6688] text-sm italic leading-relaxed mb-8">Show me how pathetic your hunger is. I want to see you panic. Tap the button <span className="text-[#FF2A6D] font-black uppercase text-glow">25 times</span> before the <span className="text-[#FF2A6D] font-black uppercase text-glow">5 seconds</span> run out. Break your fingers for my amusement, and I might just feed you for free.</p>
                     <button onClick={handleStartGame} className="w-full bg-gradient-to-r from-[#FF2A6D] via-[#880E4F] to-[#FF2A6D] text-white py-6 rounded-[2rem] font-black uppercase tracking-[0.4em] text-[11px] shadow-glow active:scale-95 transition-all">I AM ON MY KNEES</button>
                     <button onClick={handleSafeword} className="mt-8 text-red-500 text-[10px] font-black uppercase tracking-[0.4em] underline decoration-red-500/50 hover:text-red-400 transition-all">Safeword (Skip & Pay)</button>
                   </>
                 )}
                 {devotionStatus === 'playing' && (
                   <div className="animate-in fade-in duration-300">
                     <p className="text-[10px] text-[#AD6688] font-black uppercase tracking-[0.4em] mb-2 animate-pulse">Seconds to Disappointment</p>
                     <p className={`text-6xl font-black italic text-[#FF2A6D] text-glow mb-6 tabular-nums ${timeLeft <= 2 ? 'animate-bounce scale-110 text-[#F48FB1]' : ''}`}>{timeLeft.toFixed(1)}s</p>
                     <div className="w-full bg-[#0A0206] rounded-full h-4 mb-8 overflow-hidden border border-[#FF2A6D]/40 shadow-inner"><div className="bg-gradient-to-r from-[#880E4F] via-[#FF2A6D] to-[#F48FB1] h-full transition-all duration-75 shadow-glow" style={{width: `${Math.min(100, (begs/25)*100)}%`}} /></div>
                     <button onClick={handleBegAction} className="w-full bg-[#0A0206] border-4 border-[#FF2A6D] text-[#FF2A6D] py-12 rounded-[3rem] font-black text-3xl uppercase tracking-[0.2em] shadow-[0_0_40px_rgba(255,42,109,0.4)] active:bg-[#FF2A6D] active:text-white transition-all duration-75 select-none active:scale-95 flex flex-col items-center justify-center gap-2">
                       <span>{getBegText(begs)}</span>
                       <span className="text-[10px] tracking-[0.5em] opacity-50">{begs} / 25</span>
                     </button>
                     <button onClick={handleSafeword} className="mt-8 text-red-500 text-[10px] font-black uppercase tracking-[0.4em] underline decoration-red-500/50 hover:text-red-400 transition-all">Safeword (Skip & Pay)</button>
                   </div>
                 )}

                 {/* The Punishment Sub-Routine */}
                 {devotionStatus === 'punished' && (
                   <div className="animate-in fade-in zoom-in-95 duration-500">
                       <AlertTriangle size={48} className="text-[#880E4F] mx-auto mb-4 animate-shake shadow-glow" />
                       <h3 className="text-4xl font-black italic text-[#880E4F] mb-2 tracking-tighter uppercase text-glow">Pathetic Failure</h3>
                       <p className="text-[#AD6688] text-sm italic mb-8">You are too slow. Before I even let you try again, you must pay for your incompetence.</p>
                       
                       <div className="bg-[#0A0206]/80 p-6 rounded-3xl border border-[#880E4F]/50 mb-6 shadow-inner relative overflow-hidden">
                           
                           {/* Level 0: Forced Correct Typing */}
                           {currentPunishmentLevel === 0 && (
                               <div className="space-y-4">
                                   <Zap size={32} className="text-[#FF2A6D] mx-auto mb-2" />
                                   <p className="text-[11px] text-[#FCE4EC] font-black uppercase tracking-widest text-glow">Discipline Typing</p>
                                   <p className="text-[#AD6688] italic text-sm">Type exactly: "i am a pathetic greedy pet for my master"</p>
                                   <textarea 
                                       value={typingPunishmentText} 
                                       onChange={handleTypingPunishment} 
                                       className="w-full bg-transparent border-b border-[#FF2A6D] text-[#FCE4EC] outline-none text-center italic mt-4 resize-none" 
                                       rows="2"
                                       autoComplete="off" autoCorrect="off" autoCapitalize="off" spellCheck="false"
                                   ></textarea>
                                   {typingPunishmentText === "i am a pathetic greedy pet for my master" && (
                                       <button onClick={handlePunishmentComplete} className="w-full mt-4 bg-[#FF2A6D] text-white py-4 rounded-full font-black text-[10px] uppercase tracking-widest animate-pulse shadow-glow">Accept Forgiveness</button>
                                   )}
                               </div>
                           )}

                           {/* Level 1: Breath Control */}
                           {currentPunishmentLevel === 1 && (
                               <div className="space-y-4">
                                   <Activity size={32} className="text-[#FF2A6D] mx-auto mb-2" />
                                   <p className="text-[11px] text-[#FCE4EC] font-black uppercase tracking-widest text-glow">Breath Control</p>
                                   <p className="text-[#AD6688] italic text-sm">Hold your breath. Press and hold to endure the pain for 15 seconds.</p>
                                   <button 
                                      onTouchStart={startPunishmentHold} onMouseDown={startPunishmentHold}
                                      onTouchEnd={stopPunishmentHold} onMouseUp={stopPunishmentHold} onMouseLeave={stopPunishmentHold}
                                      className="w-full h-24 rounded-2xl bg-[#1A030C] border-2 border-[#880E4F] relative overflow-hidden flex items-center justify-center mt-4"
                                   >
                                       <div className="absolute left-0 bottom-0 w-full bg-gradient-to-t from-[#880E4F] to-[#FF2A6D] transition-all duration-150" style={{height: `${punishmentTimer}%`}} />
                                       <span className="relative z-10 text-white font-black uppercase tracking-widest">{punishmentTimer >= 100 ? 'RELEASE' : 'HOLD IT IN'}</span>
                                   </button>
                                   {punishmentTimer >= 100 && (
                                       <button onClick={handlePunishmentComplete} className="w-full mt-4 bg-[#FF2A6D] text-white py-4 rounded-full font-black text-[10px] uppercase tracking-widest shadow-glow">Breathe</button>
                                   )}
                               </div>
                           )}

                           {/* Level 2: Surveillance */}
                           {currentPunishmentLevel === 2 && (
                               <div className="space-y-4">
                                   <Camera size={32} className="text-[#FF2A6D] mx-auto mb-2" />
                                   <p className="text-[11px] text-[#FCE4EC] font-black uppercase tracking-widest text-glow">Surveillance</p>
                                   <p className="text-[#AD6688] italic text-sm">I want to see your face while you fail. Stare into the lens for 10 seconds.</p>
                                   <div className="relative w-full aspect-video rounded-2xl overflow-hidden border border-[#FF2A6D] mt-4 bg-black">
                                       {isCameraActive ? <video ref={punishmentVideoRef} autoPlay playsInline muted className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-[10px] text-white animate-pulse">Requesting Access...</div>}
                                       <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,_transparent,_rgba(136,14,79,0.8))]" />
                                       <div className="absolute bottom-2 left-0 right-0 h-1 bg-[#880E4F] mx-4"><div className="h-full bg-[#FF2A6D] transition-all duration-1000" style={{width: `${punishmentTimer}%`}}></div></div>
                                   </div>
                                   {punishmentTimer >= 100 && (
                                       <button onClick={handlePunishmentComplete} className="w-full mt-4 bg-[#FF2A6D] text-white py-4 rounded-full font-black text-[10px] uppercase tracking-widest shadow-glow">Look Away</button>
                                   )}
                               </div>
                           )}

                           {/* Level 3: Silence */}
                           {currentPunishmentLevel === 3 && (
                               <div className="space-y-4">
                                   <Radio size={32} className={`mx-auto mb-2 ${punishmentHoldTimerId ? 'text-[#FF2A6D] animate-pulse' : 'text-[#880E4F]'}`} />
                                   <p className="text-[11px] text-[#FCE4EC] font-black uppercase tracking-widest text-glow">Silence Protocol</p>
                                   <p className="text-[#AD6688] italic text-sm pointer-events-none">You are forbidden to speak or moan. Press to begin and remain completely silent for 15 seconds. If Master hears you, the timer restarts.</p>
                                   
                                   <div className="w-full h-32 rounded-2xl bg-[#1A030C] border-2 border-[#880E4F] flex flex-col items-center justify-center mt-4">
                                        {punishmentHoldTimerId ? (
                                            <>
                                                <span className="text-4xl font-black text-[#FF2A6D] tabular-nums mb-2 pointer-events-none">{Math.max(0, 15 - Math.floor(punishmentTimer * 0.15))}s</span>
                                                <div className="w-2/3 h-2 bg-[#0A0206] rounded-full pointer-events-none overflow-hidden"><div className="h-full bg-[#FF2A6D] transition-all duration-100" style={{width: `${punishmentTimer}%`}} /></div>
                                            </>
                                        ) : (
                                            <button onClick={startSilencePunishment} className="w-full h-full flex items-center justify-center text-[#FF2A6D] font-black uppercase tracking-widest animate-pulse hover:bg-[#FF2A6D]/10 transition-all rounded-2xl">Begin Trial</button>
                                        )}
                                   </div>
                                   
                                   {punishmentTimer >= 100 && (
                                       <button onClick={handlePunishmentComplete} className="w-full mt-4 bg-[#FF2A6D] text-white py-4 rounded-full font-black text-[10px] uppercase tracking-widest shadow-glow relative z-20">You May Speak</button>
                                   )}
                               </div>
                           )}

                           {/* Level 4: Vocal Humiliation */}
                           {currentPunishmentLevel === 4 && (
                               <div className="space-y-4">
                                   <Mic size={32} className={`mx-auto mb-2 ${punishmentHoldTimerId ? 'text-[#FF2A6D] animate-pulse' : 'text-[#880E4F]'}`} />
                                   <p className="text-[11px] text-[#FCE4EC] font-black uppercase tracking-widest text-glow">Vocal Humiliation</p>
                                   <p className="text-[#AD6688] italic text-sm pointer-events-none">Master demands a deep, passive moan. Not a scream. Press to begin and sustain your desperation until he is satisfied.</p>
                                   
                                   <div className="w-full h-32 rounded-2xl bg-[#1A030C] border-2 border-[#880E4F] flex flex-col items-center justify-center mt-4 relative overflow-hidden">
                                        {punishmentHoldTimerId ? (
                                            <>
                                                <span className="text-4xl font-black text-[#FF2A6D] tabular-nums mb-2 pointer-events-none z-10">{Math.floor(punishmentTimer)}%</span>
                                                <div className="w-2/3 h-2 bg-[#0A0206] rounded-full pointer-events-none overflow-hidden z-10"><div className="h-full bg-[#FF2A6D] transition-all duration-100" style={{width: `${punishmentTimer}%`}} /></div>
                                                <div className="absolute inset-0 bg-[#FF2A6D] opacity-10 transition-all duration-100" style={{height: `${punishmentTimer}%`, top: 'auto', bottom: 0}} />
                                            </>
                                        ) : (
                                            <button onClick={startMoanPunishment} className="w-full h-full flex items-center justify-center text-[#FF2A6D] font-black uppercase tracking-widest animate-pulse hover:bg-[#FF2A6D]/10 transition-all rounded-2xl relative z-10">Offer Voice</button>
                                        )}
                                   </div>
                                   
                                   {punishmentTimer >= 100 && (
                                       <button onClick={handlePunishmentComplete} className="w-full mt-4 bg-[#FF2A6D] text-white py-4 rounded-full font-black text-[10px] uppercase tracking-widest shadow-glow relative z-20">Master is Satisfied</button>
                                   )}
                               </div>
                           )}

                           {/* NEW Level 5: Tap Frenzy */}
                           {currentPunishmentLevel === 5 && (
                               <div className="space-y-4">
                                   <HandMetal size={32} className="text-[#FF2A6D] mx-auto mb-2" />
                                   <p className="text-[11px] text-[#FCE4EC] font-black uppercase tracking-widest text-glow">Spank Frenzy</p>
                                   <p className="text-[#AD6688] italic text-sm">Tap the button <span className="text-[#FF2A6D] font-black">50 times</span> to beg for mercy. You have no time limit, but Master is watching you struggle.</p>
                                   <div className="w-full h-32 rounded-2xl bg-[#1A030C] border-2 border-[#880E4F] flex flex-col items-center justify-center mt-4">
                                       <button onClick={() => {
                                           triggerHaptic('light');
                                           setFrenzyTaps(t => t + 1);
                                           if (frenzyTaps + 1 === 50) triggerHaptic('continuous');
                                       }} className="w-full h-full flex items-center justify-center text-[#FF2A6D] font-black text-3xl hover:bg-[#FF2A6D]/10 transition-all rounded-2xl active:scale-95">
                                           {frenzyTaps < 50 ? `${frenzyTaps} / 50` : 'SUFFICIENT'}
                                       </button>
                                   </div>
                                   {frenzyTaps >= 50 && (
                                       <button onClick={handlePunishmentComplete} className="w-full mt-4 bg-[#FF2A6D] text-white py-4 rounded-full font-black text-[10px] uppercase tracking-widest shadow-glow">Accept Grace</button>
                                   )}
                               </div>
                           )}

                           {/* NEW Level 6: Embarrassing Moan Audio */}
                           {currentPunishmentLevel === 6 && (
                               <div className="space-y-4">
                                   <Volume2 size={32} className="text-[#FF2A6D] mx-auto mb-2 animate-pulse" />
                                   <p className="text-[11px] text-[#FCE4EC] font-black uppercase tracking-widest text-glow">Public Embarrassment</p>
                                   <p className="text-[#AD6688] italic text-sm">Turn your volume all the way up. Master demands you listen to the sound of true desperation.</p>
                                   
                                   {punishmentTimer === 0 ? (
                                       <button onClick={() => {
                                           triggerHaptic('heavy');
                                           setPunishmentTimer(1);
                                           const moanAudio = new Audio("https://res.cloudinary.com/db8xboovt/video/upload/v1771955364/767671a4_poj8zn.mp3"); // Using vocal prompt as placeholder for deep moan
                                           moanAudio.volume = 1.0;
                                           moanAudio.play().catch(e => console.log(e));
                                           
                                           let t = 0;
                                           const interval = setInterval(() => {
                                               t++;
                                               setPunishmentTimer(t);
                                               if (t >= 100) clearInterval(interval);
                                           }, 100); // 10 seconds of playback
                                       }} className="w-full h-24 bg-[#1A030C] border-2 border-[#880E4F] rounded-2xl text-[#FF2A6D] font-black uppercase mt-4 hover:bg-[#FF2A6D]/10 active:scale-95 transition-all">
                                           Accept Audio Discipline
                                       </button>
                                   ) : (
                                       <div className="w-full h-24 rounded-2xl bg-[#1A030C] border-2 border-[#880E4F] flex flex-col items-center justify-center mt-4 overflow-hidden relative">
                                            <div className="absolute left-0 bottom-0 h-full bg-[#FF2A6D] transition-all duration-100 opacity-20" style={{width: `${punishmentTimer}%`}} />
                                            <span className="relative z-10 text-white font-black italic tracking-widest">Enduring...</span>
                                       </div>
                                   )}
                                   {punishmentTimer >= 100 && (
                                       <button onClick={handlePunishmentComplete} className="w-full mt-4 bg-[#FF2A6D] text-white py-4 rounded-full font-black text-[10px] uppercase tracking-widest shadow-glow">I Have Learned</button>
                                   )}
                               </div>
                           )}
                       </div>
                       <button onClick={handleSafeword} className="mt-8 text-red-500 text-[10px] font-black uppercase tracking-[0.4em] underline decoration-red-500/50 hover:text-red-400 transition-all">Safeword (Skip & Pay)</button>
                   </div>
                 )}

                 {devotionStatus === 'retry_prompt' && (
                     <div className="animate-in fade-in zoom-in duration-500">
                         <h3 className="text-3xl font-black italic text-[#FF2A6D] mb-4 uppercase text-glow">You Survived</h3>
                         <p className="text-[#AD6688] text-sm italic mb-8">But you haven't earned your meal. Are you ready to try again? <span className="text-[#FF2A6D] font-black block mt-2">The punishment level escalates with every failure.</span></p>
                         <button onClick={handleStartGame} className="w-full bg-[#FF2A6D] text-white py-6 rounded-[2rem] font-black uppercase tracking-[0.4em] text-[11px] shadow-glow active:scale-95 transition-all">YES MASTER, I WILL BE QUICK</button>
                         <button onClick={handleSafeword} className="mt-8 text-red-500 text-[10px] font-black uppercase tracking-[0.4em] underline decoration-red-500/50 hover:text-red-400 transition-all">Safeword (Skip & Pay)</button>
                     </div>
                 )}

                 {devotionStatus === 'vocal' && (
                   <div className="animate-in fade-in zoom-in-95 duration-700">
                     <Mic size={64} className={`mx-auto mb-6 transition-all duration-500 ${isListening ? 'text-[#FF2A6D] scale-125 shadow-[0_0_50px_rgba(255,42,109,0.8)]' : 'text-[#880E4F] animate-pulse'}`} />
                     <h3 className="text-3xl font-black italic text-[#FCE4EC] mb-4 tracking-tighter uppercase text-glow">The Final Surrender</h3>
                     <p className="text-[#FCE4EC] text-xl font-black italic mb-8 border-b border-[#FF2A6D]/30 pb-6">"Have you been a good girl?"</p>
                     <div className="bg-[#0A0206]/80 p-8 rounded-[2.5rem] border border-[#FF2A6D]/40 mb-8 shadow-2xl relative overflow-hidden">
                        <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,_rgba(255,42,109,0.1),_transparent)] pointer-events-none" />
                        <p className="text-[11px] text-[#AD6688] font-medium italic mb-8 leading-relaxed relative z-10">Drop to your knees. Look up at the screen. Press the microphone and whisper with absolute, trembling obedience:<br/><br/><span className="text-[#FF2A6D] font-black text-lg not-italic uppercase tracking-widest text-glow">"Yes Master"</span></p>
                        <button 
                          onClick={startVocalTrial} 
                          disabled={isListening}
                          className={`w-full py-6 rounded-2xl flex items-center justify-center gap-4 transition-all relative z-10 ${isListening ? 'bg-[#FF2A6D] text-white shadow-[0_0_30px_rgba(255,42,109,0.6)] scale-105' : 'bg-[#1A030C] border border-[#FF2A6D]/40 text-[#FF2A6D] hover:bg-[#FF2A6D]/10'}`}
                        >
                          {isListening ? <Loader2 size={24} className="animate-spin" /> : <Mic size={24} />}
                          <span className="font-black uppercase tracking-[0.4em] text-xs leading-none mt-1">{isListening ? 'HE IS LISTENING...' : 'SUBMIT YOUR VOW'}</span>
                        </button>
                     </div>
                   </div>
                 )}
                 {devotionStatus === 'won' && (
                   <div className="animate-in zoom-in duration-700">
                     <Lock size={64} className="text-[#FF2A6D] mx-auto mb-6 shadow-glow" fill="currentColor" />
                     <h3 className="text-5xl font-black italic text-[#FCE4EC] mb-4 tracking-tighter uppercase text-glow">Good Pet.</h3>
                     <p className="text-[#AD6688] text-base italic leading-relaxed mb-8">Look at you, panting and desperate. You make such a beautiful mess when you panic for me. Your absolute submission has earned my boundless favor. Your cravings are now yours to consume for <span className="text-[#FF2A6D] font-black uppercase text-glow">Free</span>.</p>
                     <button onClick={closeGameModal} className="w-full bg-gradient-to-r from-[#FF2A6D] to-[#880E4F] text-white py-6 rounded-[2rem] font-black uppercase tracking-[0.5em] text-[12px] shadow-glow active:scale-95 transition-all">KISS HIS HAND IN GRATITUDE</button>
                   </div>
                 )}
              </div>
            </div>
          )}
          {showSettings && role === 'master' && (
            <div className="max-w-6xl mx-auto px-6 mt-6 animate-in slide-in-from-top duration-700">
              <div className="bg-[#1A030C] border border-[#F48FB1]/20 rounded-[3.5rem] p-12 text-white shadow-2xl space-y-10 relative overflow-hidden lg:text-left leading-tight text-center">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                  <div className="space-y-6">
                    <p className="text-[#F48FB1] font-black uppercase tracking-[0.5em] text-[10px] text-center lg:text-left">Covenant Contacts</p>
                    <div className="grid grid-cols-1 gap-4">
                      <input type="email" placeholder="Master Email" className="w-full bg-[#0A0206]/70 backdrop-blur-md border border-white/10 rounded-2xl px-6 py-4 text-white outline-none focus:border-[#9C27B0]/60 transition-all italic leading-tight" value={emailSettings.bfEmail} onChange={e => setEmailSettings({...emailSettings, bfEmail: e.target.value})} />
                      <input type="email" placeholder="Submissive Email" className="w-full bg-[#0A0206]/70 backdrop-blur-md border border-white/10 rounded-2xl px-6 py-4 text-white outline-none focus:border-[#FF2A6D]/60 transition-all italic leading-tight" value={emailSettings.gfEmail} onChange={e => setEmailSettings({...emailSettings, gfEmail: e.target.value})} />
                      <input type="text" placeholder="WhatsApp Number" className="w-full bg-[#0A0206]/70 backdrop-blur-md border border-white/10 rounded-2xl px-6 py-4 text-white outline-none focus:border-[#F48FB1]/60 transition-all italic" value={emailSettings.whatsappNumber} onChange={e => setEmailSettings({...emailSettings, whatsappNumber: e.target.value})} />
                      <input type="text" placeholder="Instagram Username" className="w-full bg-[#0A0206]/70 backdrop-blur-md border border-white/10 rounded-2xl px-6 py-4 text-white outline-none focus:border-[#FF2A6D]/60 transition-all italic" value={emailSettings.instaUsername} onChange={e => setEmailSettings({...emailSettings, instaUsername: e.target.value})} />
                    </div>
                  </div>

                  <div className="space-y-6">
                    <p className="text-[#9C27B0] font-black uppercase tracking-[0.5em] text-[10px] text-center lg:text-left">Voice Decree (Trial Prompt)</p>
                    <div className="bg-[#0A0206]/50 p-6 rounded-3xl border border-[#9C27B0]/30 space-y-6">
                      <p className="text-[11px] text-[#AD6688] italic">Record your voice saying: <br/><span className="text-[#FCE4EC] font-bold">"Have you been a good girl?"</span></p>
                      <div className="flex gap-4">
                        <button 
                          onClick={isRecordingMaster ? stopMasterRecording : startMasterRecording}
                          className={`flex-1 py-4 rounded-2xl flex items-center justify-center gap-3 transition-all ${isRecordingMaster ? 'bg-[#FF2A6D] text-white animate-pulse' : 'bg-[#1A030C] border border-[#9C27B0]/40 text-[#9C27B0] hover:bg-[#9C27B0] hover:text-white'}`}
                        >
                          {isRecordingMaster ? <CircleStop size={18} /> : <Mic size={18} />}
                          <span className="font-black uppercase tracking-widest text-[9px]">{isRecordingMaster ? 'STOP RECORDING' : 'START RECORDING'}</span>
                        </button>
                        {emailSettings.masterVoiceBase64 && (
                          <button 
                            onClick={() => {
                                triggerHaptic('light');
                                const audio = new Audio(emailSettings.masterVoiceBase64);
                                audio.volume = 1.0;
                                audio.play();
                            }}
                            className="p-4 bg-[#0A0206] border border-white/10 rounded-2xl text-white hover:text-[#FF2A6D] transition-all"
                          >
                            <Play size={18} />
                          </button>
                        )}
                        {emailSettings.masterVoiceBase64 && (
                          <button 
                            onClick={() => { triggerHaptic('light'); setEmailSettings(prev => ({...prev, masterVoiceBase64: null})); }}
                            className="p-4 bg-[#0A0206] border border-white/10 rounded-2xl text-white hover:text-red-500 transition-all"
                          >
                            <Trash2 size={18} />
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
                <button onClick={saveSettingsToCloud} className="w-full bg-gradient-to-r from-[#FF2A6D] via-[#9C27B0] to-[#FF2A6D] text-white py-6 rounded-[2.5rem] font-black uppercase tracking-[0.4em] text-xs leading-tight shadow-2xl hover:shadow-glow transition-all">
                  {isSavingSettings ? <Loader2 size={20} className="animate-spin mx-auto" /> : 'LOCK VAULT'}
                </button>
              </div>
            </div>
          )}
          <main className="max-w-6xl mx-auto px-8 py-16 relative z-10 leading-tight">
            {currentAdIndex !== -1 && (
              <div className="mb-12 relative overflow-hidden rounded-[3rem] bg-[#1A030C] border border-[#FF2A6D]/30 flex flex-col sm:flex-row group shadow-[0_0_40px_rgba(255,42,109,0.1)] animate-in slide-in-from-top-10 fade-in duration-700">
                <div className="relative sm:w-2/5 h-64 sm:h-auto overflow-hidden">
                  <GoddessImage src={ADVERTISEMENTS[currentAdIndex].image} alt="Ad" className="w-full h-full object-cover" />
                  <div className="absolute inset-0 bg-gradient-to-t sm:bg-gradient-to-r from-[#1A030C] via-[#1A030C]/50 to-transparent opacity-90 sm:opacity-100" />
                </div>
                <div className="p-8 sm:p-12 flex-1 flex flex-col justify-center relative z-10 -mt-20 sm:mt-0 sm:-ml-20">
                  <div className="flex justify-between items-start mb-6">
                    <div className="flex items-center gap-3 text-[#FF2A6D] uppercase font-black tracking-[0.5em] text-[10px] bg-[#0A0206]/80 px-4 py-2 rounded-full border border-[#FF2A6D]/20 backdrop-blur-md">
                      <Megaphone size={14} className="animate-pulse" /> <span>Official Decree</span>
                    </div>
                    <button onClick={closeAd} className="p-2 bg-[#0A0206]/80 rounded-full border border-white/10 text-[#884466] hover:text-[#FF2A6D] hover:border-[#FF2A6D]/50 transition-all backdrop-blur-md">
                      <X size={16} />
                    </button>
                  </div>
                  <h2 className="text-3xl sm:text-4xl font-black italic text-white mb-2 uppercase tracking-tighter leading-none">{ADVERTISEMENTS[currentAdIndex].title}</h2>
                  <h3 className="text-[#FF2A6D] text-sm sm:text-base font-black italic uppercase tracking-widest mb-4">{ADVERTISEMENTS[currentAdIndex].subtitle}</h3>
                  <p className="text-[#AD6688] italic text-sm leading-relaxed mb-8 max-w-xl">{ADVERTISEMENTS[currentAdIndex].description}</p>
                  <button onClick={closeAd} className="self-start px-8 py-4 bg-gradient-to-r from-[#FF2A6D] to-[#880E4F] rounded-full text-white font-black uppercase tracking-[0.3em] text-[10px] hover:shadow-glow active:scale-95 transition-all">
                    {currentAdIndex === ADVERTISEMENTS.length - 1 ? 'Acknowledge & Proceed' : 'View Next Decree'}
                  </button>
                </div>
              </div>
            )}
            
            {role === 'master' && masterView === 'terminal' && (
                <div className="animate-in fade-in zoom-in-95 duration-700">
                    <div className="bg-[#050103] border border-[#FF2A6D]/40 rounded-[3rem] p-10 shadow-[0_0_80px_rgba(255,42,109,0.3)] relative overflow-hidden">
                        <div className="absolute inset-0 bg-[linear-gradient(rgba(255,42,109,0.05)_1px,transparent_1px),linear-gradient(90deg,rgba(255,42,109,0.05)_1px,transparent_1px)] bg-[size:40px_40px] opacity-20 pointer-events-none" />
                        <div className="flex items-center gap-4 text-[#FF2A6D] mb-10">
                            <Radio className="animate-pulse" size={40} />
                            <div>
                                <h2 className="text-4xl font-black uppercase tracking-tighter text-glow">Live Command Interface</h2>
                                <p className="text-[#AD6688] font-black tracking-[0.3em] text-[10px] uppercase">Remote Submissive Override Protocol Active</p>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 relative z-10">
                            {/* Standard Level Kinks */}
                            <button onClick={() => triggerMasterCommand('blindfold')} className="bg-[#1A030C] border border-[#9C27B0]/50 p-6 rounded-2xl flex flex-col items-center gap-4 hover:bg-[#9C27B0]/20 transition-all group">
                                <EyeOff size={32} className="text-[#9C27B0] group-hover:scale-125 transition-transform" />
                                <span className="font-black uppercase tracking-widest text-xs text-[#FCE4EC]">Trigger Blindfold</span>
                            </button>
                            <button onClick={() => triggerMasterCommand('hijack')} className="bg-[#1A030C] border border-[#FF2A6D]/50 p-6 rounded-2xl flex flex-col items-center gap-4 hover:bg-[#FF2A6D]/20 transition-all group">
                                <Crosshair size={32} className="text-[#FF2A6D] group-hover:scale-125 transition-transform" />
                                <span className="font-black uppercase tracking-widest text-xs text-[#FCE4EC]">Hijack Screen</span>
                            </button>
                            <button onClick={() => triggerMasterCommand('release_hijack')} className="bg-[#1A030C] border border-green-500/50 p-6 rounded-2xl flex flex-col items-center gap-4 hover:bg-green-500/20 transition-all group">
                                <ShieldCheck size={32} className="text-green-500 group-hover:scale-125 transition-transform" />
                                <span className="font-black uppercase tracking-widest text-xs text-[#FCE4EC]">Release Screen</span>
                            </button>
                            <button onClick={() => triggerMasterCommand('vibrate')} className="bg-[#1A030C] border border-blue-500/50 p-6 rounded-2xl flex flex-col items-center gap-4 hover:bg-blue-500/20 transition-all group">
                                <Smartphone size={32} className="text-blue-500 group-hover:scale-125 transition-transform animate-shake" />
                                <span className="font-black uppercase tracking-widest text-xs text-[#FCE4EC]">Remote Vibrate</span>
                            </button>

                            {/* Max Kink Overloads (NEW) */}
                            <button onClick={() => triggerMasterCommand('shock')} className="bg-[#1A030C] border-2 border-red-600/70 p-6 rounded-2xl flex flex-col items-center gap-4 hover:bg-red-600/20 transition-all group shadow-[0_0_15px_rgba(255,0,0,0.4)]">
                                <Zap size={32} className="text-red-500 group-hover:scale-125 transition-transform animate-pulse" />
                                <span className="font-black uppercase tracking-widest text-xs text-[#FCE4EC]">Shock Collar (Overload)</span>
                            </button>

                            <button onClick={() => triggerMasterCommand('hypnotize')} className="bg-[#1A030C] border-2 border-fuchsia-500/70 p-6 rounded-2xl flex flex-col items-center gap-4 hover:bg-fuchsia-500/20 transition-all group shadow-[0_0_15px_rgba(217,70,239,0.4)]">
                                <Ghost size={32} className="text-fuchsia-500 group-hover:scale-125 transition-transform" />
                                <span className="font-black uppercase tracking-widest text-xs text-[#FCE4EC]">Hypnotic Trance</span>
                            </button>

                            <button onClick={() => triggerMasterCommand('confess')} className="bg-[#1A030C] border-2 border-[#FF2A6D]/70 p-6 rounded-2xl flex flex-col items-center gap-4 hover:bg-[#FF2A6D]/20 transition-all group shadow-[0_0_15px_rgba(255,42,109,0.4)]">
                                <MessageCircle size={32} className="text-[#FF2A6D] group-hover:scale-125 transition-transform" />
                                <span className="font-black uppercase tracking-widest text-xs text-[#FCE4EC]">Force Confession</span>
                            </button>

                            <button onClick={() => triggerMasterCommand('moan')} className="bg-[#1A030C] border-2 border-[#F48FB1]/70 p-6 rounded-2xl flex flex-col items-center gap-4 hover:bg-[#F48FB1]/20 transition-all group shadow-[0_0_15px_rgba(244,143,177,0.4)]">
                                <Mic size={32} className="text-[#F48FB1] group-hover:scale-125 transition-transform" />
                                <span className="font-black uppercase tracking-widest text-[10px] text-[#FCE4EC] text-center">Demand Deep Moan<br/>(Frequencies Monitored)</span>
                            </button>

                            <button onClick={() => triggerMasterCommand('edge')} className="bg-[#1A030C] border border-orange-500/50 p-6 rounded-2xl flex flex-col items-center gap-4 hover:bg-orange-500/20 transition-all group col-span-1 md:col-span-2 lg:col-span-4">
                                <AlertOctagon size={32} className="text-orange-500 group-hover:scale-125 transition-transform" />
                                <span className="font-black uppercase tracking-widest text-xs text-[#FCE4EC]">Total Checkout Denial (30s Edging)</span>
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {role === 'submissive' && (
              <section className="animate-in fade-in zoom-in-95 duration-1000 leading-tight">
                <div className="relative w-full h-[40vh] sm:h-[50vh] rounded-[3rem] overflow-hidden mb-12 border border-[#E91E63]/30 shadow-[0_0_60px_rgba(233,30,99,0.2)] group">
                  <video src="https://res.cloudinary.com/db8xboovt/video/upload/v1771928601/Submissive_Princess_Video_Generated_jzophe.mp4" autoPlay loop muted playsInline className="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:opacity-90 group-hover:scale-105 transition-all duration-1000 ease-in-out" />
                  <div className="absolute inset-0 bg-gradient-to-t from-[#0D040A] via-[#1A030C]/50 to-transparent pointer-events-none" />
                  <div className="absolute inset-0 bg-gradient-to-r from-[#0D040A]/80 to-transparent pointer-events-none" />
                </div>
                <div className="bg-[#1A030C] p-12 rounded-[4.5rem] border border-[#FF2A6D]/20 shadow-[0_0_40px_rgba(233,30,99,0.15)] mb-12 relative overflow-hidden group lg:text-left leading-tight text-center">
                  <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')] opacity-10" />
                  <div className="relative z-10 font-black">
                    <div className="flex items-center justify-center lg:justify-start gap-3 text-[#FF2A6D] mb-8 leading-tight">
                      <Crown size={28} className="animate-pulse shadow-glow" />
                      <span className="text-[12px] font-black uppercase tracking-[0.8em] leading-tight text-[#F48FB1]">Sacred Requests</span>
                    </div>
                    <h2 className="text-6xl font-black mb-8 tracking-tighter italic text-[#FCE4EC] leading-[1.1] text-wrap">What is {activeAccount.username} <span className="text-[#FF2A6D] text-glow">{themeContent.heroVerb}</span>?</h2>
                    <p className="opacity-60 font-medium max-w-4xl text-xl leading-relaxed italic mx-auto lg:mx-0 text-wrap mb-12 text-[#FCE4EC]">{themeContent.heroSub}</p>
                    <div className="relative bg-[#0A0206]/80 backdrop-blur-xl border border-[#FF2A6D]/30 p-8 rounded-[3.5rem] shadow-2xl max-w-xl mx-auto lg:mx-0 text-center lg:text-left leading-tight">
                      <div className="flex items-center gap-3 mb-6">
                        <Stars className="text-[#F48FB1]" size={20} />
                        <p className="text-[11px] font-bold uppercase tracking-[0.3em] text-[#AD6688] text-wrap leading-tight">Whisper a custom desire to your Master...</p>
                      </div>
                      <textarea value={wishlistInput} onChange={(e) => setWishlistInput(e.target.value)} placeholder={themeContent.wishlistPlaceholder} className="w-full bg-[#1A030C]/60 border border-white/10 p-4 rounded-[2rem] text-white placeholder:text-[#4A142A] outline-none h-32 resize-none italic text-base focus:border-[#FF2A6D]/60 transition-all scrollbar-hide shadow-inner leading-tight text-wrap" />
                      <div className="flex flex-col sm:flex-row gap-4 mt-6">
                        <button onClick={handleAIBlessing} disabled={!wishlistInput.trim() || isOrdering || isAILoading} className="flex-1 bg-gradient-to-r from-[#9C27B0] to-[#4A142A] text-white py-5 rounded-[2rem] font-black flex items-center justify-center gap-3 hover:from-[#FF2A6D] hover:to-[#880E4F] active:scale-95 transition-all shadow-[0_10px_30px_rgba(156,39,176,0.3)] hover:shadow-glow uppercase tracking-[0.2em] text-[10px] border border-white/10 leading-tight">
                          {isAILoading ? <Loader2 className="animate-spin" size={18} /> : <><Sparkles size={18} fill="currentColor" /> Seek AI Blessing</>}
                        </button>
                        <button onClick={handleSendWishlist} disabled={!wishlistInput.trim() || isOrdering || isAILoading} className="flex-1 bg-[#1A030C] text-[#FF2A6D] border border-[#FF2A6D]/30 py-5 rounded-[2rem] font-black flex items-center justify-center gap-3 hover:bg-[#FF2A6D]/10 active:scale-95 transition-all uppercase tracking-[0.2em] text-[10px] leading-tight">
                          {isOrdering ? <Clock className="animate-spin" size={18} /> : <><Flame size={18} fill="currentColor" /> Tray Plea</>}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                {/* The Temptation Trap (Fake Voucher) */}
                <div className="relative w-full max-w-2xl mx-auto mb-12 p-1 rounded-3xl bg-gradient-to-r from-yellow-400 via-[#FF2A6D] to-yellow-400 animate-pulse cursor-pointer group shadow-[0_0_40px_rgba(255,42,109,0.5)]" onClick={() => {
                    triggerHaptic('punish');
                    setFailCount(fc => fc + 1); // Fixed modulo bug ensures proper re-render execution
                    setPunishmentTimer(0);
                    setTypingPunishmentText('');
                    setDevotionStatus('punished');
                    setShowDevotionTest(true);
                    addNotification("GREEDY PET", "Did you really think I would let you bypass your sacrifice? You will pay for your arrogance.", "error");
                }}>
                    <div className="bg-[#0A0206] px-8 py-6 rounded-[1.4rem] text-center flex flex-col items-center justify-center relative overflow-hidden">
                         <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,_rgba(255,215,0,0.1),_transparent)] pointer-events-none" />
                         <Gem size={32} className="text-yellow-400 mb-3 group-hover:scale-125 transition-transform duration-500" />
                         <h3 className="text-2xl font-black italic text-yellow-400 uppercase tracking-widest text-glow">Master's Black Card</h3>
                         <p className="text-[#FCE4EC] text-xs font-bold mt-2 tracking-widest uppercase opacity-80">Tap to instantly claim 100% off your entire tray.</p>
                    </div>
                </div>

                <div className="flex flex-wrap gap-4 mb-12 justify-center lg:justify-start overflow-x-auto pb-4 no-scrollbar leading-tight font-black">
                  {CATEGORIES.map(cat => (
                    <button key={cat} onClick={() => { triggerHaptic('light'); setActiveCategory(cat); }} className={`px-8 py-4 rounded-full font-black text-xs uppercase tracking-[0.2em] transition-all border ${activeCategory === cat ? 'bg-[#FF2A6D] border-[#FF2A6D] text-white shadow-[0_0_20px_rgba(233,30,99,0.5)]' : 'bg-[#260714] border-[#FF2A6D]/20 text-[#AD6688] hover:border-[#FF2A6D]/50 hover:text-white'} leading-tight`}>{cat}</button>
                  ))}
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-12 leading-tight">
                  {filteredItems.map(item => (
                    <div key={item.id} onClick={() => handleAddToCart(item)} className={`bg-[#16040C] rounded-[3.5rem] border p-3 shadow-2xl transition-all duration-700 hover:scale-[1.03] group cursor-pointer ${item.isAbsoluteOmakase || item.isMasterBody || item.category === 'Games' ? 'border-[#F48FB1]/50 shadow-[0_0_30px_rgba(244,143,177,0.2)] scale-105' : 'border-[#FF2A6D]/10 hover:border-[#FF2A6D]/30'} leading-tight`}>
                      <div className="relative h-80 rounded-[3rem] overflow-hidden shadow-inner bg-[#260714]">
                        <GoddessImage src={item.image} alt={item.name} className="w-full h-full" isVideo={item.isVideo} />
                        <div className="absolute top-6 left-6 z-20 flex gap-2">
                          <span className="bg-[#0A0206]/80 backdrop-blur-md border border-[#F48FB1]/30 px-4 py-1.5 rounded-full text-[9px] font-black uppercase tracking-[0.2em] text-[#F48FB1] leading-tight">{item.category}</span>
                        </div>
                        {item.category === 'Games' ? (
                            <button className="absolute bottom-8 right-8 z-20 bg-[#FF2A6D] text-white p-6 rounded-[1.5rem] shadow-glow scale-0 group-hover:scale-100 transition-all duration-500 active:scale-90 leading-tight font-black"><Ghost size={36} /></button>
                        ) : (
                            <button className="absolute bottom-8 right-8 z-20 bg-[#FF2A6D] text-white p-6 rounded-[1.5rem] shadow-glow scale-0 group-hover:scale-100 transition-all duration-500 active:scale-90 leading-tight font-black"><Plus size={36} /></button>
                        )}
                      </div>
                      <div className="p-10 text-center lg:text-left text-wrap leading-tight">
                        <h3 className={`font-black text-2xl italic tracking-tight mb-2 text-wrap leading-tight ${item.isAbsoluteOmakase || item.isMasterBody || item.category === 'Games' ? 'text-[#F48FB1]' : 'text-[#FCE4EC]'}`}>{item.name}</h3>
                        <p className="text-[#B86688] text-base mb-10 italic leading-relaxed opacity-80 leading-tight text-wrap">"{item.description}"</p>
                        <div className="flex items-center justify-between border-t border-[#FF2A6D]/10 pt-8 leading-tight">
                          <span className="text-4xl font-black text-[#FF2A6D] tracking-tighter leading-tight">${item.price.toFixed(2)}</span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </section>
            )}
            
            {role === 'master' && masterView === 'orders' && (
              <section className="animate-in fade-in duration-1000 space-y-12 leading-tight">
                <div className="relative w-full h-[35vh] sm:h-[45vh] rounded-[3rem] overflow-hidden mb-10 border border-[#9C27B0]/30 shadow-[0_0_60px_rgba(156,39,176,0.2)] group">
                  <video src="https://res.cloudinary.com/db8xboovt/video/upload/v1771928601/Submissive_Princess_Video_Generated_jzophe.mp4" autoPlay loop muted playsInline className="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-80 group-hover:scale-105 transition-all duration-1000 ease-in-out" />
                  <div className="absolute inset-0 bg-gradient-to-t from-[#0D040A] via-[#1A030C]/50 to-transparent pointer-events-none" />
                  <div className="absolute inset-0 bg-gradient-to-r from-[#0D040A]/80 to-transparent pointer-events-none" />
                </div>
                 <h2 className="text-5xl font-black text-[#FCE4EC] italic tracking-tighter leading-none text-wrap">{themeContent.altarTitle}</h2>
                 
                 {incomingOrders.length === 0 && (
                    <div className="text-center p-12 bg-[#16040C] rounded-[3rem] border border-[#FF2A6D]/10">
                        <p className="text-[#AD6688] italic text-lg">The altar is empty. Waiting for the submissive to speak...</p>
                    </div>
                 )}

                 <div className="grid gap-12 leading-tight font-black">
                  {incomingOrders.sort((a,b) => b.timestamp - a.timestamp).map(order => (
                    <div key={order.id} className="bg-[#16040C] p-12 rounded-[5rem] border-l-[16px] border-l-[#9C27B0] border border-[#FF2A6D]/10 shadow-2xl flex flex-col lg:flex-row lg:items-center justify-between gap-12 group leading-tight text-wrap transition-all hover:bg-[#1C0615] font-black">
                      <div className="flex-1 text-wrap leading-tight font-black">
                        <div className="flex items-center gap-4 mb-8">
                          <span className={`text-[12px] font-black uppercase tracking-[0.4em] px-6 py-2.5 rounded-full shadow-2xl inline-block ${order.type === 'wishlist' ? 'bg-[#FF2A6D] text-white shadow-[0_0_20px_rgba(233,30,99,0.5)]' : 'bg-[#9C27B0] text-white'} leading-tight`}>{order.type === 'wishlist' ? 'FORBIDDEN DESIRE' : 'NEW COMMAND'}</span>
                          <span className="text-[#B86688] text-xs italic font-black uppercase tracking-widest">From: <span className="text-[#F48FB1]">{order.pledgerName || 'Bella'}</span></span>
                        </div>
                        {order.type === 'wishlist' ? (
                          <div className="bg-[#0A0206]/80 border border-[#FF2A6D]/30 p-10 rounded-[3rem] text-2xl font-bold italic text-[#FCE4EC] shadow-inner relative leading-relaxed text-wrap overflow-hidden leading-tight font-black">
                            <span className="absolute -top-4 left-10 bg-[#16040C] px-4 py-1 rounded-b-xl text-[11px] text-[#FF2A6D] uppercase tracking-[0.5em] leading-tight font-black">Her Whisper</span>"{order.text}"
                          </div>
                        ) : (
                          <div className="flex flex-wrap gap-5 leading-tight text-wrap font-black">
                            {order.items?.map((it, idx) => (
                              <div key={idx} className="bg-[#0A0206]/80 border border-[#9C27B0]/40 px-8 py-5 rounded-[2rem] flex flex-col gap-1 shadow-2xl leading-tight text-wrap font-black">
                                <div className="flex items-center gap-5 leading-tight text-wrap font-black">
                                  <span className="bg-[#FF2A6D] w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-xl text-sm font-black text-white leading-none shadow-glow">{it.qty}</span>
                                  <span className="text-xl font-bold text-[#FCE4EC] italic text-wrap leading-tight font-black">{it.name}</span>
                                </div>
                                {it.options && <div className="pl-14 text-[10px] text-[#B86688] font-black uppercase tracking-widest text-wrap leading-tight font-black pt-2">
                                  {it.options.bound && <span className="text-[#F48FB1] font-black mr-2">MASTER BODY CLAIMED | </span>}
                                  {it.options.vow && <span className="text-[#FF2A6D] font-black mr-2">VOW OF PALATE SILENCE | </span>}
                                  {!it.options.bound && !it.options.vow && (
                                    <div className="opacity-80 leading-relaxed">
                                      {it.options.meat && <span>{it.options.meat} | </span>}
                                      {it.options.doneness && <span>{it.options.doneness} | </span>}
                                      {it.options.style && <span>{it.options.style} | </span>}
                                      {it.options.sugar && <span>SUGAR: {it.options.sugar} | </span>}
                                      {it.options.temp && <span>{it.options.temp} | </span>}
                                      {it.options.topping && <span>TOPPING: {it.options.topping} | </span>}
                                      {it.options.spice && <span>SPICE: {it.options.spice} | </span>}
                                      {it.options.pasta && <span>TYPE: {it.options.pasta} | </span>}
                                      {it.options.sauce && <span>SAUCE: {it.options.sauce} | </span>}
                                      {it.options.kfcSauce && <span>GLAZE: {it.options.kfcSauce} | </span>}
                                      {it.options.juice && <span>JUICE: {it.options.juice} | </span>}
                                      {it.options.chicken && <span>PREP: {it.options.chicken} | </span>}
                                      {it.options.request && <span className="text-white italic">REQ: {it.options.request} | </span>}
                                    </div>
                                  )}
                                </div>}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                      <div className="text-right leading-tight font-black">
                        <p className="text-[12px] text-[#884466] font-black uppercase tracking-[0.4em] mb-3 leading-tight font-black">SACRIFICE TOTAL</p>
                        <p className="text-6xl font-black text-[#FCE4EC] tracking-tighter italic leading-tight tabular-nums font-black text-glow">${order.total?.toFixed(2)}</p>
                        <button className="mt-8 bg-gradient-to-b from-[#9C27B0] to-[#4A142A] text-white h-20 px-12 rounded-[2.5rem] font-black flex items-center gap-5 hover:from-[#FF2A6D] hover:to-[#880E4F] transition-all duration-1000 shadow-2xl leading-tight font-black hover:shadow-glow" onClick={async () => {
                            if (user) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', order.id));
                        }}><Heart size={28} /><span>FULFILL</span></button>
                      </div>
                    </div>
                  ))}
                </div>
              </section>
            )}
          </main>

          {/* AI Decree Modal Overlay */}
          {aiDecree && (
            <div className="fixed inset-0 z-[300] flex items-center justify-center p-6 bg-[#0A0206]/95 backdrop-blur-3xl animate-in fade-in duration-500">
               <div className="relative bg-[#1A030C] border border-[#FF2A6D]/50 rounded-[4rem] p-10 max-w-lg w-full text-center shadow-[0_0_80px_rgba(255,42,109,0.3)] animate-in zoom-in-95 duration-700">
                   <Sparkles className="text-[#FF2A6D] mx-auto mb-6 w-16 h-16 animate-pulse drop-shadow-[0_0_15px_rgba(255,42,109,0.8)]" />
                   <h3 className="text-3xl font-black italic text-[#FCE4EC] mb-6 uppercase tracking-tighter">The Oracle Has Spoken</h3>
                   <p className="text-[#AD6688] text-sm italic mb-4">You begged for: <span className="text-[#FCE4EC] font-bold">"{aiDecree.originalRequest}"</span></p>
                   <p className="text-[#FCE4EC] text-xl font-black italic leading-relaxed mb-8 border-y border-[#FF2A6D]/30 py-8 shadow-inner bg-[#0A0206]/50 rounded-3xl px-6">"{aiDecree.text}"</p>
                   {aiDecree.isApproved ? (
                       <div className="mb-8">
                         <span className="bg-[#FF2A6D]/20 text-[#FF2A6D] border border-[#FF2A6D] px-6 py-2 rounded-full font-black uppercase tracking-widest text-[10px] animate-pulse">Your Desire Was Forced Into Your Tray</span>
                       </div>
                   ) : (
                       <div className="mb-8">
                         <span className="bg-[#880E4F]/20 text-[#880E4F] border border-[#880E4F] px-6 py-2 rounded-full font-black uppercase tracking-widest text-[10px]">You Are Denied. Learn Your Place.</span>
                       </div>
                   )}
                   <button onClick={() => { triggerHaptic('light'); setAiDecree(null); }} className="w-full bg-gradient-to-r from-[#FF2A6D] via-[#9C27B0] to-[#FF2A6D] text-white py-5 rounded-full font-black uppercase tracking-[0.4em] text-[10px] shadow-glow active:scale-95 transition-all">Kiss His Hand & Acknowledge</button>
               </div>
            </div>
          )}

          {customizingItem && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 leading-tight font-black">
              <div className="absolute inset-0 bg-[#0A0206]/95 backdrop-blur-3xl leading-tight" onClick={() => setCustomizingItem(null)} />
              <div className="relative bg-[#1A030C] border border-[#F48FB1]/30 p-10 rounded-[4rem] w-full max-w-lg shadow-[0_0_50px_rgba(233,30,99,0.2)] animate-in zoom-in-95 duration-500 overflow-y-auto max-h-[90vh] leading-tight font-black">
                <div className="absolute top-0 right-0 p-8 opacity-10 pointer-events-none leading-none"><LickinGoodLogo className="w-40 h-40" /></div>
                <div className="flex items-center justify-between mb-10 text-center lg:text-left text-wrap leading-tight font-black">
                  <div className="max-w-[85%] leading-tight text-wrap font-black">
                    <h3 className="text-3xl font-black italic text-[#FCE4EC] tracking-tight uppercase leading-tight font-black">{customizingItem.name}</h3>
                    <p className="text-[#AD6688] text-sm italic mt-1 uppercase tracking-widest leading-tight font-black">Master Specification Ritual</p>
                  </div>
                  <button onClick={() => { triggerHaptic('light'); setCustomizingItem(null); }} className="p-3 bg-white/5 rounded-full text-[#884466] hover:text-[#FF2A6D] hover:bg-[#FF2A6D]/10 transition-all flex-shrink-0 leading-tight font-black"><X size={24} /></button>
                </div>
                <div className="space-y-10 relative z-10 pb-4 text-center lg:text-left text-wrap leading-tight font-black">
                  {customizingItem.isMasterBody && (
                    <section className="bg-[#1A030C] backdrop-blur-md border-2 border-[#FF2A6D] p-10 rounded-3xl text-center leading-tight font-black shadow-[0_0_50px_rgba(255,42,109,0.4)] relative overflow-hidden">
                      <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,_rgba(255,42,109,0.15),_transparent)] pointer-events-none animate-pulse" />
                      <Skull size={48} className="text-[#FF2A6D] mx-auto mb-6 leading-tight shadow-glow animate-bounce" />
                      <p className="text-[#FF2A6D] font-black uppercase tracking-[0.3em] text-lg mb-4 leading-tight text-glow">THE ULTIMATE SACRIFICE</p>
                      <p className="text-[#FCE4EC] text-base italic mb-8 leading-relaxed text-wrap font-black border-y border-[#FF2A6D]/30 py-6">"You are not ordering a meal. You are begging to be completely used and consumed by my dominance. By accepting this holy grail, you forfeit all rights to your own body. You will drop to your naked knees, part your trembling lips, and take every drop of what I force upon you. You will choke, you will weep, and you will thank me for the absolute privilege of being my personal, helpless property. Acknowledge your pathetic desperation."</p>
                      <button onClick={() => { triggerHaptic('light'); setVowOfSilence(!vowOfSilence); }} className={`w-full py-6 rounded-2xl font-black text-[11px] uppercase transition-all border-2 leading-tight font-black relative z-10 ${vowOfSilence ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_30px_rgba(255,42,109,0.8)] scale-105' : 'bg-[#0A0206]/80 border-[#FF2A6D]/50 text-[#FF2A6D] hover:bg-[#FF2A6D]/10 hover:shadow-glow'}`}>{vowOfSilence ? 'OWNED, BOUND, AND GAGGED' : 'I AM YOUR HELPLESS TOY, USE ME'}</button>
                    </section>
                  )}
                  {customizingItem.isAbsoluteOmakase && (
                    <section className="bg-[#0A0206]/60 backdrop-blur-md border border-[#FF2A6D]/30 p-8 rounded-3xl text-center leading-tight font-black">
                      <Lock size={32} className="text-[#FF2A6D] mx-auto mb-4 leading-tight shadow-glow animate-pulse" />
                      <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-xs mb-4 leading-tight font-black text-glow">Vow of Palate Silence</p>
                      <p className="text-[#B86688] text-sm italic mb-6 leading-tight text-wrap font-black">"I surrender all choice. My Master will decide my feast. I will swallow whatever is forced upon my tongue without question."</p>
                      <button onClick={() => { triggerHaptic('light'); setVowOfSilence(!vowOfSilence); }} className={`w-full py-4 rounded-2xl font-black text-[10px] uppercase transition-all border leading-tight font-black ${vowOfSilence ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-glow' : 'bg-[#0A0206]/60 border-white/10 text-[#884466] hover:text-[#FF2A6D]'}`}>{vowOfSilence ? 'VOW RECORDED' : 'RECORD VOW OF SILENCE'}</button>
                    </section>
                  )}
                  {!customizingItem.isMasterBody && !customizingItem.isAbsoluteOmakase && (
                    <div className="space-y-6">
                      {customizingItem.category === 'Drinks' && !customizingItem.hasJuiceChoice && (
                        <div className="space-y-6">
                          <div className="space-y-3">
                            <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px]">Sugar Surrender</p>
                            <div className="flex flex-wrap gap-2">{['0%', '25%', '50%', '100%'].map(s => (<button key={s} onClick={() => { triggerHaptic('light'); setSugarLevel(s); }} className={`px-4 py-2 rounded-full font-black text-[10px] uppercase transition-all border ${sugarLevel === s ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_15px_rgba(255,42,109,0.4)]' : 'bg-[#0A0206]/60 border-white/10 text-[#AD6688] hover:border-[#FF2A6D]/50'}`}>{s}</button>))}</div>
                          </div>
                          <div className="space-y-3">
                            <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px]">Temperature Decree</p>
                            <div className="flex flex-wrap gap-2">{['No Ice', 'Less Ice', 'Normal Ice', 'Hot'].map(t => (<button key={t} onClick={() => { triggerHaptic('light'); setTempLevel(t); }} className={`px-4 py-2 rounded-full font-black text-[10px] uppercase transition-all border ${tempLevel === t ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_15px_rgba(255,42,109,0.4)]' : 'bg-[#0A0206]/60 border-white/10 text-[#AD6688] hover:border-[#FF2A6D]/50'}`}>{t}</button>))}</div>
                          </div>
                        </div>
                      )}
                      {customizingItem.hasMeatChoice && (
                        <div className="space-y-3">
                          <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px]">Flesh Sacrifice</p>
                          <div className="flex flex-wrap gap-2">{['Chicken', 'Pork', 'Beef', 'Seafood'].map(m => (<button key={m} onClick={() => { triggerHaptic('light'); setMeatChoice(m); }} className={`px-4 py-2 rounded-full font-black text-[10px] uppercase transition-all border ${meatChoice === m ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_15px_rgba(255,42,109,0.4)]' : 'bg-[#0A0206]/60 border-white/10 text-[#AD6688] hover:border-[#FF2A6D]/50'}`}>{m}</button>))}</div>
                        </div>
                      )}
                      {customizingItem.hasDonenessChoice && (
                        <div className="space-y-3">
                          <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px]">Seared Submission</p>
                          <div className="flex flex-wrap gap-2">{['Rare', 'Medium Rare', 'Medium', 'Well Done'].map(d => (<button key={d} onClick={() => { triggerHaptic('light'); setDoneness(d); }} className={`px-4 py-2 rounded-full font-black text-[10px] uppercase transition-all border ${doneness === d ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_15px_rgba(255,42,109,0.4)]' : 'bg-[#0A0206]/60 border-white/10 text-[#AD6688] hover:border-[#FF2A6D]/50'}`}>{d}</button>))}</div>
                        </div>
                      )}
                      {customizingItem.hasYogurtToppings && (
                        <div className="space-y-3">
                          <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px]">Sweet Temptation</p>
                          <div className="flex flex-wrap gap-2">{['Grapes', 'Blueberry', 'Strawberry', 'Granola', 'Banana'].map(t => (<button key={t} onClick={() => { triggerHaptic('light'); setYogurtTopping(t); }} className={`px-4 py-2 rounded-full font-black text-[10px] uppercase transition-all border ${yogurtTopping === t ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_15px_rgba(255,42,109,0.4)]' : 'bg-[#0A0206]/60 border-white/10 text-[#AD6688] hover:border-[#FF2A6D]/50'}`}>{t}</button>))}</div>
                        </div>
                      )}
                      {customizingItem.hasSpiceLevel && (
                        <div className="space-y-3">
                          <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px]">Agony Level</p>
                          <div className="flex flex-wrap gap-2">{['Mild', 'Medium Hot', 'Thai Hot', 'Master\'s Punishment'].map(s => (<button key={s} onClick={() => { triggerHaptic('light'); setSpiceLevel(s); }} className={`px-4 py-2 rounded-full font-black text-[10px] uppercase transition-all border ${spiceLevel === s ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_15px_rgba(255,42,109,0.4)]' : 'bg-[#0A0206]/60 border-white/10 text-[#AD6688] hover:border-[#FF2A6D]/50'}`}>{s}</button>))}</div>
                        </div>
                      )}
                      {customizingItem.hasPastaChoice && (
                        <div className="space-y-3">
                          <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px]">Silken Strands (Pasta Type)</p>
                          <div className="flex flex-wrap gap-2">{['Spaghetti', 'Fettuccine', 'Penne', 'Linguine'].map(p => (<button key={p} onClick={() => { triggerHaptic('light'); setPastaType(p); }} className={`px-4 py-2 rounded-full font-black text-[10px] uppercase transition-all border ${pastaType === p ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_15px_rgba(255,42,109,0.4)]' : 'bg-[#0A0206]/60 border-white/10 text-[#AD6688] hover:border-[#FF2A6D]/50'}`}>{p}</button>))}</div>
                        </div>
                      )}
                      {customizingItem.hasSauceChoice && (
                        <div className="space-y-3">
                          <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px]">Thick Nectar (Sauce)</p>
                          <div className="flex flex-wrap gap-2">{['Creamy Alfredo', 'Spicy Marinara', 'Rich Pesto', 'Truffle Mushroom'].map(s => (<button key={s} onClick={() => { triggerHaptic('light'); setPastaSauce(s); }} className={`px-4 py-2 rounded-full font-black text-[10px] uppercase transition-all border ${pastaSauce === s ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_15px_rgba(255,42,109,0.4)]' : 'bg-[#0A0206]/60 border-white/10 text-[#AD6688] hover:border-[#FF2A6D]/50'}`}>{s}</button>))}</div>
                        </div>
                      )}
                      {customizingItem.hasKfcSauceChoice && (
                        <div className="space-y-3">
                          <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px]">Sticky Glaze</p>
                          <div className="flex flex-wrap gap-2">{['Yangnyeom (Spicy Red Sauce)', 'Ganjang (Soy Garlic Glaze)', 'Mixed'].map(s => (<button key={s} onClick={() => { triggerHaptic('light'); setKfcSauce(s); }} className={`px-4 py-2 rounded-full font-black text-[10px] uppercase transition-all border ${kfcSauce === s ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_15px_rgba(255,42,109,0.4)]' : 'bg-[#0A0206]/60 border-white/10 text-[#AD6688] hover:border-[#FF2A6D]/50'}`}>{s}</button>))}</div>
                        </div>
                      )}
                      {customizingItem.hasJuiceChoice && (
                        <div className="space-y-3">
                          <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px]">Desired Nectar (Juice Type)</p>
                          <div className="flex flex-wrap gap-2">{['Watermelon', 'Passionfruit', 'Apple', 'Orange', 'Berries', 'Omakase'].map(j => (<button key={j} onClick={() => { triggerHaptic('light'); setJuiceType(j); }} className={`px-4 py-2 rounded-full font-black text-[10px] uppercase transition-all border ${juiceType === j ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_15px_rgba(255,42,109,0.4)]' : 'bg-[#0A0206]/60 border-white/10 text-[#AD6688] hover:border-[#FF2A6D]/50'}`}>{j}</button>))}</div>
                        </div>
                      )}
                      {customizingItem.hasChickenTypeChoice && (
                        <div className="space-y-3">
                          <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px]">Preparation Ritual</p>
                          <div className="flex flex-wrap gap-2">{['Fried', 'Steamed', 'Mixed'].map(c => (<button key={c} onClick={() => { triggerHaptic('light'); setChickenChoice(c); }} className={`px-4 py-2 rounded-full font-black text-[10px] uppercase transition-all border ${chickenChoice === c ? 'bg-[#FF2A6D] text-white border-[#FF2A6D] shadow-[0_0_15px_rgba(255,42,109,0.4)]' : 'bg-[#0A0206]/60 border-white/10 text-[#AD6688] hover:border-[#FF2A6D]/50'}`}>{c}</button>))}</div>
                        </div>
                      )}
                      <div className="space-y-3">
                        <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px] flex items-center gap-2 font-black"><ClipboardList size={14} /> Whisper Your Demands (Special Requests / Allergies)</p>
                        <textarea value={specialRequest} onChange={(e) => setSpecialRequest(e.target.value)} placeholder="Specify any allergies or specific desires for your Master to consider... ðŸ’‹" className="w-full bg-[#0A0206]/60 border border-[#FF2A6D]/20 p-4 rounded-2xl text-white placeholder:text-[#4A142A] outline-none h-24 resize-none text-sm italic focus:border-[#FF2A6D]/60 transition-all shadow-inner" />
                      </div>
                    </div>
                  )}
                  <button disabled={(customizingItem.isAbsoluteOmakase || customizingItem.isMasterBody) && !vowOfSilence} onClick={() => { triggerHaptic('light'); addToCartFinal(customizingItem, { sugar: customizingItem.category === 'Drinks' ? sugarLevel : null, temp: customizingItem.category === 'Drinks' ? tempLevel : null, style: customizingItem.isCoffee ? coffeeStyle : null, meat: customizingItem.hasMeatChoice ? meatChoice : null, doneness: customizingItem.hasDonenessChoice ? doneness : null, topping: customizingItem.hasYogurtToppings ? yogurtTopping : null, spice: customizingItem.hasSpiceLevel ? spiceLevel : null, pasta: customizingItem.hasPastaChoice ? pastaType : null, sauce: customizingItem.hasSauceChoice ? pastaSauce : null, kfcSauce: customizingItem.hasKfcSauceChoice ? kfcSauce : null, juice: customizingItem.hasJuiceChoice ? juiceType : null, chicken: customizingItem.hasChickenTypeChoice ? chickenChoice : null, request: specialRequest, vow: (customizingItem.isAbsoluteOmakase || customizingItem.isMasterBody) && vowOfSilence, bound: customizingItem.isMasterBody && vowOfSilence }); }} className={`w-full bg-gradient-to-r from-[#FF2A6D] via-[#9C27B0] to-[#FF2A6D] text-white py-6 rounded-[2rem] font-black shadow-[0_10px_30px_rgba(255,42,109,0.3)] uppercase tracking-[0.4em] text-[10px] mt-4 leading-tight active:scale-95 transition-all font-black ${(customizingItem.isAbsoluteOmakase || customizingItem.isMasterBody) && !vowOfSilence ? 'opacity-20 grayscale' : 'hover:shadow-[0_10px_40px_rgba(255,42,109,0.5)]'}`}>Confirm Specification</button>
                </div>
              </div>
            </div>
          )}
          {isCartOpen && (
            <div className="fixed inset-0 z-[60] font-black">
              <div className="absolute inset-0 bg-[#0A0206]/95 backdrop-blur-2xl leading-tight font-black" onClick={() => setIsCartOpen(false)} />
              <div className="absolute inset-y-0 right-0 w-full max-w-lg bg-[#16040C] shadow-[-20px_0_100px_rgba(233,30,99,0.2)] flex flex-col animate-in slide-in-from-right duration-700 border-l border-[#FF2A6D]/20 overflow-hidden">
                <div className="px-8 py-10 flex items-center justify-between border-b border-[#FF2A6D]/10 bg-[#0D0408]/50 backdrop-blur-md sticky top-0 z-20">
                    <h2 className="text-2xl font-black italic text-[#FCE4EC] tracking-tight uppercase">THE TRAY</h2>
                    <button onClick={() => { triggerHaptic('light'); setIsCartOpen(false); }} className="p-2.5 bg-[#260714] rounded-full text-[#AD6688] hover:text-[#FF2A6D] transition-all"><X size={20} /></button>
                </div>
                {isOrdering && (
                    <div className="flex-1 flex flex-col items-center justify-center p-12">
                        <MapPin size={48} className="text-[#FF2A6D] animate-pulse mb-6" />
                        <h3 className="text-2xl font-black text-[#FF2A6D] uppercase">Validating Confinement</h3>
                        <p className="text-[#AD6688] italic mt-4 mb-2 text-center text-[10px] uppercase tracking-widest">Pinging GPS Coordinates...</p>
                        <p className="text-white font-black font-mono text-xs">{gpsStatus}</p>
                    </div>
                )}
                {!isOrdering && orderComplete ? (
                  <div className="flex-1 flex flex-col items-center justify-center text-center p-12 animate-in fade-in zoom-in-95 duration-1000">
                     <div className="w-20 h-20 bg-[#FF2A6D]/20 border border-[#FF2A6D] rounded-full flex items-center justify-center mb-6 shadow-glow"><Check size={40} className="text-[#FF2A6D] font-black" /></div>
                     <h3 className="text-2xl font-black italic text-[#FCE4EC] mb-4 uppercase text-glow">Ritual Complete</h3>
                     <p className="text-[#AD6688] text-sm italic leading-relaxed">Your pleas have been sent into the abyss. Both Master and you will receive word. Wait quietly for his decree. ðŸ’‹</p>
                  </div>
                ) : !isOrdering && (
                  <div className="flex-1 overflow-y-auto custom-scrollbar flex flex-col">
                    <div className="p-6 space-y-6 flex-grow">
                      {cart.length === 0 ? (
                        <div className="h-40 flex flex-col items-center justify-center opacity-30 text-[#FF2A6D]"><ShoppingBag size={48} /><p className="mt-4 font-black italic text-lg text-[#FCE4EC]">The tray is empty...</p></div>
                      ) : (
                        cart.map(item => (
                          <div key={item.cartId} className="flex gap-4 items-center bg-[#0A0206]/80 p-5 rounded-[2rem] border border-[#FF2A6D]/10 relative overflow-hidden group transition-all hover:bg-[#1A030C]">
                            <div className="flex-1 min-w-0 z-10">
                              <p className="font-black text-lg text-[#FCE4EC] italic leading-tight mb-2 truncate uppercase">{item.name}</p>
                              {item.options && <div className="text-[10px] text-[#B86688] font-black uppercase tracking-widest text-wrap leading-relaxed font-black">
                                {item.options.bound && <span className="text-[#F48FB1] font-black">MASTER BODY CLAIMED | </span>}
                                {item.options.vow && <span className="text-[#FF2A6D] font-black">VOW OF PALATE SILENCE | </span>}
                                {!item.options.bound && !item.options.vow && (
                                  <div className="opacity-75">
                                    {item.options.meat && <span>{item.options.meat} | </span>}
                                    {item.options.doneness && <span>{item.options.doneness} | </span>}
                                    {item.options.style && <span>{item.options.style} | </span>}
                                    {item.options.sugar && <span>SGR: {item.options.sugar} | </span>}
                                    {item.options.temp && <span>{item.options.temp} | </span>}
                                    {item.options.topping && <span>TOP: {item.options.topping} | </span>}
                                    {item.options.spice && <span>SPC: {item.options.spice} | </span>}
                                    {item.options.pasta && <span>TYPE: {item.options.pasta} | </span>}
                                    {item.options.sauce && <span>SAUCE: {item.options.sauce} | </span>}
                                    {item.options.kfcSauce && <span>GLAZE: {item.options.kfcSauce} | </span>}
                                    {item.options.juice && <span>JUICE: {item.options.juice} | </span>}
                                    {item.options.chicken && <span>PREP: {item.options.chicken} | </span>}
                                    {item.options.request && <span className="text-white italic">REQ: {item.options.request} | </span>}
                                  </div>
                                )}
                              </div>}
                              <p className="text-[#FF2A6D] font-black text-[11px] mt-2 uppercase tracking-[0.1em]">Sacrifice: ${(item.price * item.quantity).toFixed(2)}</p>
                            </div>
                            <div className="flex items-center gap-3 bg-[#16040C] p-2 rounded-xl border border-[#FF2A6D]/10 z-10 flex-shrink-0">
                              <button onClick={() => { triggerHaptic('light'); if (item.quantity === 1) setCart(prev => prev.filter(i => i.cartId !== item.cartId)); else setCart(prev => prev.map(i => i.cartId === item.cartId ? {...i, quantity: i.quantity - 1} : i)); }} className="text-[#884466] hover:text-[#FF2A6D] transition-all transform hover:scale-110"><Minus size={16} /></button>
                              <span className="font-black text-[#FCE4EC] w-4 text-center text-sm tabular-nums">{item.quantity}</span>
                              <button onClick={() => { triggerHaptic('light'); setCart(prev => prev.map(i => i.cartId === item.cartId ? {...i, quantity: i.quantity + 1} : i)); }} className="text-[#884466] hover:text-[#FF2A6D] transition-all transform hover:scale-110"><Plus size={16} /></button>
                            </div>
                          </div>
                        ))
                      )}
                    </div>
                    {cart.length > 0 && (
                      <div className="p-8 border-t border-[#FF2A6D]/20 bg-[#0D0408]/80 backdrop-blur-lg space-y-6">
                        
                        <div className="space-y-3 border-b border-[#FF2A6D]/20 pb-6">
                            <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px] flex items-center gap-2 font-black"><MapPin size={14} /> Verify Delivery Confinement</p>
                            <textarea value={deliveryAddress} onChange={(e) => setDeliveryAddress(e.target.value)} placeholder="Enter delivery address..." className="w-full bg-[#0A0206]/60 border border-[#FF2A6D]/20 p-4 rounded-xl text-white placeholder:text-[#4A142A] outline-none h-16 resize-none text-xs italic focus:border-[#FF2A6D]/60 transition-all shadow-inner" />
                            
                            {!activeAccount?.email && (
                                <>
                                    <p className="text-[#FF2A6D] font-black uppercase tracking-[0.2em] text-[10px] flex items-center gap-2 font-black mt-4"><Send size={14} /> Contact Whisper (Email required)</p>
                                    <input type="email" value={checkoutEmail} onChange={(e) => setCheckoutEmail(e.target.value)} placeholder="Enter email to receive Master's decree..." className="w-full bg-[#0A0206]/60 border border-[#FF2A6D]/20 px-4 py-3 rounded-xl text-white placeholder:text-[#4A142A] outline-none text-xs italic focus:border-[#FF2A6D]/60 transition-all shadow-inner" />
                                </>
                            )}
                        </div>

                        <div className="flex justify-between items-center text-2xl font-black text-[#FCE4EC] italic tracking-tight">
                          <span className="text-[#AD6688] text-sm uppercase tracking-widest not-italic">TOTAL INDULGENCE</span>
                          <div className="flex flex-col items-end gap-0.5">
                            {hasVoucher && <span className="text-[#AD6688] text-base line-through decoration-[#FF2A6D] opacity-60 font-medium">${(cartSubtotal + 2.99).toFixed(2)}</span>}
                            <span className="text-[#F48FB1] tabular-nums">{hasVoucher ? 'FREE' : `$${cartTotalDisplay.toFixed(2)}`}</span>
                          </div>
                        </div>
                        {hasVoucher ? (
                          <div className="animate-in slide-in-from-bottom duration-500">
                            <div className="bg-[#FF2A6D]/10 border border-[#FF2A6D]/30 p-4 rounded-2xl text-center mb-6"><p className="text-[#FF2A6D] text-[10px] uppercase tracking-[0.3em] font-black text-glow animate-pulse">Master's Favor Granted</p></div>
                            <button disabled={isOrdering} onClick={handlePlaceOrder} className="w-full bg-gradient-to-r from-[#FF2A6D] via-[#9C27B0] to-[#880E4F] text-white py-6 rounded-[2rem] font-black text-xl uppercase tracking-[0.3em] italic border border-white/10 shadow-glow active:scale-95 transition-all flex items-center justify-center gap-4">{isOrdering ? <Loader2 className="animate-spin" size={24} /> : <><span className="mt-0.5 uppercase">Command Him</span> <Flame size={24} fill="currentColor" /></>}</button>
                          </div>
                        ) : (
                          <div className="space-y-6 animate-in fade-in duration-500">
                             <div className="flex items-center gap-3"><div className="h-px bg-[#FF2A6D]/10 flex-1" /><span className="text-[#884466] text-[9px] uppercase tracking-[0.4em] font-black">Method of Tribute</span><div className="h-px bg-[#FF2A6D]/10 flex-1" /></div>
                             <button onClick={() => { triggerHaptic('light'); setShowDevotionTest(true); }} className="w-full bg-[#1A030C] border border-[#FF2A6D]/40 text-[#FF2A6D] hover:bg-[#FF2A6D] hover:text-white py-5 rounded-[1.5rem] font-black uppercase tracking-[0.2em] text-[11px] transition-all flex items-center justify-center gap-3 shadow-[0_0_20px_rgba(255,42,109,0.1)]"><Heart size={18} /><span>Beg For Master's Favor (Free)</span></button>
                             <div className="bg-[#0A0206]/60 p-5 rounded-[2rem] border border-[#330044] space-y-4">
                               <p className="text-[#AD6688] text-[9px] uppercase tracking-widest font-black flex items-center gap-2 opacity-70 font-black"><CreditCard size={14}/> Pay with Plastic</p>
                               <input type="text" placeholder="Card Number" value={ccDetails.number} onChange={e => setCcDetails({...ccDetails, number: e.target.value})} className="w-full bg-[#1A030C] border border-[#330044] px-4 py-3 rounded-xl text-[#E5C9D7] outline-none focus:border-[#FF2A6D]/50 transition-all text-xs placeholder:text-[#4A142A]" />
                               <div className="flex gap-3">
                                 <input type="text" placeholder="MM/YY" value={ccDetails.expiry} onChange={e => setCcDetails({...ccDetails, expiry: e.target.value})} className="w-1/2 bg-[#1A030C] border border-[#330044] px-4 py-3 rounded-xl text-[#E5C9D7] outline-none focus:border-[#FF2A6D]/50 transition-all text-xs placeholder:text-[#4A142A]" />
                                 <input type="text" placeholder="CVC" value={ccDetails.cvc} onChange={e => setCcDetails({...ccDetails, cvc: e.target.value})} className="w-1/2 bg-[#1A030C] border border-[#330044] px-4 py-3 rounded-xl text-[#E5C9D7] outline-none focus:border-[#FF2A6D]/50 transition-all text-xs placeholder:text-[#4A142A]" />
                               </div>
                               <button onClick={handleCCSubmit} disabled={isCcProcessing} className="w-full bg-[#330044]/50 text-[#AD6688] hover:bg-[#4A142A] hover:text-white py-3.5 rounded-xl font-black uppercase tracking-[0.2em] text-[9px] transition-all flex items-center justify-center">{isCcProcessing ? <Loader2 className="animate-spin" size={14} /> : "Submit Pathetic Currency"}</button>
                             </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          )}
          <div className="fixed bottom-8 right-8 z-[100] flex flex-col items-end gap-4 leading-tight font-black">
            <div className="flex gap-4 font-black">
              <a href="https://ig.me/m/heyitsdonghui" target="_blank" rel="noopener noreferrer" onClick={() => triggerHaptic('light')} className="p-6 rounded-full shadow-[0_10px_30px_rgba(233,30,99,0.3)] transition-all transform hover:scale-110 active:scale-95 border border-[#FF2A6D]/20 leading-tight font-black bg-[#1A030C] text-[#AD6688] hover:text-[#FF2A6D]">
                <Instagram size={28} />
              </a>
              <a href="https://wa.me/6587234130" target="_blank" rel="noopener noreferrer" onClick={() => triggerHaptic('light')} className="p-6 rounded-full shadow-[0_10px_30px_rgba(233,30,99,0.3)] transition-all transform hover:scale-110 active:scale-95 border border-[#FF2A6D]/20 leading-tight font-black bg-[#1A030C] text-[#AD6688] hover:text-[#FF2A6D]">
                <MessageCircle size={28} />
              </a>
            </div>
          </div>
          <style>{`
            @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,900;1,400;1,900&family=Montserrat:wght@400;900&display=swap');
            :root { font-family: 'Playfair Display', serif; }
            .no-scrollbar::-webkit-scrollbar { display: none; }
            .text-glow { text-shadow: 0 0 15px rgba(255, 42, 109, 0.6); }
            .shadow-glow { filter: drop-shadow(0 0 12px rgba(255, 42, 109, 0.6)); }
            .scrollbar-hide::-webkit-scrollbar { display: none; }
            .custom-scrollbar::-webkit-scrollbar { width: 4px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background: #FF2A6D22; border-radius: 10px; }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #FF2A6D44; }
          `}</style>
        </div>
      );
    };

    const rootElement = document.getElementById('root');
    const root = createRoot(rootElement);
    root.render(<App />);
</script>
</body>
</html>
